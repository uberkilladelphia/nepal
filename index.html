<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Infinite Time Thread</title>

  <link rel="preconnect" href="https://fonts.googleapis.com/">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Anton&family=Fira+Code:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#050505;
      --white:#ffffff;
      --red:#FF2E2E;

      --ui-primary: var(--white);
      --ui-accent: var(--red);
      --ui-muted: rgba(255,255,255,.62);
      --ui-line: rgba(255,255,255,.22);

      --panel-bg: rgba(255,46,46,0.88);
      --panel-border: rgba(255,255,255,0.60);
      --panel-text: rgba(255,255,255,0.98);

      /* SMALL SWITCH (TOP-LEFT) */
      --switch-w: 168px;
      --switch-h: 16px;
      --switch-pad: 2px;

      /* OFF mode readability */
      --off-ink: #111;
      --off-bg: #f6f6f6;
      --off-line: #111;
      --off-soft: #bdbdbd;
    }

    html{
      height:100%;
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
    }

    body{
      margin:0;
      overflow:hidden;
      height: calc(var(--vh, 1vh) * 100);
      width:100vw;
      background:var(--bg);
      font-family:'Inter',sans-serif;
      user-select:none;
      -webkit-user-select:none;
      cursor: default;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior: none;
      touch-action: manipulation;
    }

    body.invert{
      --ui-primary: var(--red);
      --ui-accent: var(--white);

      --panel-bg: rgba(255,255,255,0.90);
      --panel-border: rgba(0,0,0,0.30);
      --panel-text: rgba(255,46,46,0.98);
    }

    /* ========= SMALL SWITCH (TOP-LEFT) ========= */
    .topbar{
      position:fixed;
      top:14px;
      left:14px;
      z-index:200;
      pointer-events:auto;
    }

    .ios-switch{
      width: var(--switch-w);
      height: var(--switch-h);
      display:flex;
      align-items:center;
      gap:10px;
      pointer-events:auto;
    }

    .ios-switch .label{
      font-size: 10px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.80);
      display:flex;
      gap:8px;
      align-items:center;
      pointer-events:none;
      line-height:1;
      font-family: 'Fira Code', monospace;
      font-weight:700;
    }

    .ios-switch .label span{
      opacity:0.55;
      transition: opacity .18s steps(12,end), color .18s steps(12,end);
    }
    .ios-switch[data-state="on"] .label .on{ opacity:1; color: rgba(255,255,255,0.98); }
    .ios-switch[data-state="on"] .label .off{ opacity:0.35; }
    .ios-switch[data-state="off"] .label .off{ opacity:1; color: rgba(255,255,255,0.98); }
    .ios-switch[data-state="off"] .label .on{ opacity:0.35; }

    .track{
      position: relative;
      width: calc(var(--switch-w) - 64px);
      height: var(--switch-h);
      border-radius: 999px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.30);
      overflow:hidden;
      flex: 0 0 auto;
    }

    .thumb{
      position:absolute;
      top: var(--switch-pad);
      left: var(--switch-pad);
      width: calc(50% - (var(--switch-pad) * 2));
      height: calc(100% - (var(--switch-pad) * 2));
      border-radius: 999px;
      background: rgba(255,255,255,0.92);
      transition: transform .22s steps(12,end), background .18s steps(12,end);
      transform: translateX(0);
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
    }

    .ios-switch[data-state="on"] .thumb{
      transform: translateX(100%);
      background: rgba(255,46,46,0.95);
    }

    .track-btn{
      position:absolute;
      inset:0;
      background: transparent;
      border:0;
      cursor:pointer;
      padding:0;
    }

    /* Make switch readable on OFF (light) background */
    body.mode-off .ios-switch .label{
      color: rgba(0,0,0,0.92);
      text-shadow: none;
    }
    body.mode-off .ios-switch .label span{ opacity:0.55; }
    body.mode-off .ios-switch[data-state="off"] .label .off{
      opacity:1;
      color: rgba(0,0,0,0.98);
    }
    body.mode-off .ios-switch[data-state="on"] .label .on{
      opacity:1;
      color: rgba(0,0,0,0.98);
    }

    body.mode-off .track{
      background: rgba(0,0,0,0.10);
      border-color: rgba(0,0,0,0.42);
      box-shadow: 2px 2px 0 rgba(0,0,0,0.88);
    }
    body.mode-off .thumb{
      background: rgba(255,255,255,0.98);
      border: 1px solid rgba(0,0,0,0.35);
      box-shadow: 2px 2px 0 rgba(0,0,0,0.88);
    }
    body.mode-off .ios-switch[data-state="on"] .thumb{
      background: rgba(255,46,46,0.96);
      border-color: rgba(0,0,0,0.30);
    }

    /* ========= OFF SCENE (PIXEL DESKTOP + MESSENGER) ========= */
    .off-scene{
      position:fixed;
      inset:0;
      z-index:50;
      display:none;
      pointer-events:none;
      height: calc(var(--vh, 1vh) * 100);
    }
    body.mode-off .off-scene{
      display:block;
      pointer-events:auto;
    }
    body.mode-off .on-scene{
      opacity:0;
      pointer-events:none;
    }

    .pixel-desktop{
      position:absolute;
      inset:0;
      background:
        linear-gradient(0deg, rgba(0,0,0,0.06), rgba(0,0,0,0.06)),
        repeating-linear-gradient(90deg, rgba(0,0,0,0.03) 0 1px, transparent 1px 3px),
        repeating-linear-gradient(0deg, rgba(0,0,0,0.03) 0 1px, transparent 1px 3px),
        var(--off-bg);
      image-rendering: pixelated;
      filter: saturate(0.95);
    }

    .pixel-taskbar{
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      height: 44px;
      background: #e9e9e9;
      border-top: 3px solid #cfcfcf;
      box-shadow: inset 0 2px 0 rgba(255,255,255,0.6);
      display:flex;
      align-items:center;
      gap:10px;
      padding: 0 10px;
      font-family: 'Fira Code', monospace;
      font-size: 12px;
      color:#1a1a1a;
      image-rendering: pixelated;
    }
    .pixel-start{
      background:#fff;
      border:2px solid #1a1a1a;
      padding: 6px 10px;
      box-shadow: 2px 2px 0 #1a1a1a;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight:700;
    }
    .pixel-clock{
      margin-left:auto;
      background:#fff;
      border:2px solid #1a1a1a;
      padding: 6px 10px;
      box-shadow: 2px 2px 0 #1a1a1a;
    }

    .messenger-window{
      position:absolute;
      left:50%;
      top:52%;
      transform:translate(-50%,-50%);
      width: min(980px, 92vw);
      height: min(560px, 64vh);
      background:#ffffff;
      border:4px solid var(--red);
      box-shadow: 8px 8px 0 rgba(0,0,0,0.85);
      image-rendering: pixelated;
      font-family: 'Fira Code', monospace;
      color:#111;
      display:flex;
      flex-direction:column;
    }

    .messenger-titlebar{
      height:44px;
      background: #fff;
      border-bottom: 3px solid #111;
      display:flex;
      align-items:center;
      padding: 0 12px;
      gap:10px;
      font-weight:800;
      letter-spacing:0.14em;
      text-transform:uppercase;
    }
    .win-dots{ display:flex; gap:8px; margin-left:auto; }
    .dot{ width:12px; height:12px; background:#111; box-shadow: 2px 2px 0 #111; }
    .dot.red{ background: var(--red); box-shadow: 2px 2px 0 #111; }

    .messenger-body{
      flex:1;
      display:grid;
      grid-template-columns: 320px 1fr;
      min-height:0;
    }

    /* Tabs list */
    .sidebar{
      border-right: 3px solid #111;
      background:
        repeating-linear-gradient(0deg, rgba(0,0,0,0.04) 0 1px, transparent 1px 3px),
        #fdfdfd;
      padding: 10px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
    }
    .tab{
      border:2px solid #111;
      box-shadow: 2px 2px 0 #111;
      padding: 8px 10px;
      margin-bottom: 10px;
      background:#fff;
      font-weight:800;
      letter-spacing:0.06em;
      cursor:pointer;
      user-select:none;
      transition: transform .14s steps(12,end);
      pointer-events:auto;
      touch-action: manipulation;
    }
    .tab:active{ transform: translate(1px,1px); }
    .tab.active{
      border-color: var(--red);
      box-shadow: 2px 2px 0 #111, 0 0 0 2px rgba(255,46,46,0.18) inset;
    }

    /* Content pane */
    .pane{
      padding: 12px;
      overflow:auto;
      background:
        repeating-linear-gradient(0deg, rgba(0,0,0,0.03) 0 1px, transparent 1px 3px),
        #ffffff;
      min-height:0;
      position:relative;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
    }

    .pane-title{
      font-weight:900;
      letter-spacing:0.14em;
      text-transform:uppercase;
      font-size:12px;
      margin: 2px 0 10px;
      color:#111;
    }

    .pane-card{
      border:2px solid #111;
      box-shadow: 2px 2px 0 #111;
      background:#fff;
      padding: 12px;
      line-height:1.25;
      font-size: 12px;
    }

    .pixel-bullets{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
    }
    .pixel-bullets li{
      margin: 8px 0;
      padding-left: 14px;
      position:relative;
    }
    .pixel-bullets li::before{
      content:"■";
      position:absolute;
      left:0;
      top:0;
      color: var(--red);
    }

    /* Ticker marquee (loop) */
    .ticker{
      margin-top: 10px;
      border:2px solid #111;
      box-shadow: 2px 2px 0 #111;
      background:#fff;
      overflow:hidden;
      height: 34px;
      display:flex;
      align-items:center;
    }
    .ticker .track{
      width:100%;
      height:auto;
      border:none;
      background:transparent;
      box-shadow:none;
      border-radius:0;
      overflow:visible;
    }
    .ticker-line{
      white-space:nowrap;
      will-change: transform;
      font-weight:900;
      letter-spacing:0.10em;
      text-transform:uppercase;
      color: var(--red);
      padding-left: 100%;
      animation: tickerMove 14s linear infinite;
    }
    @keyframes tickerMove{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-100%); }
    }
    /* clamp to “retro fps” */
    body.mode-off .ticker-line{
      animation-timing-function: steps(168, end);
    }

    /* Horizontal learning blocks */
    .grid4{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .grid4 .block{
      border:2px solid #111;
      box-shadow: 2px 2px 0 #111;
      background:#fff;
      padding: 10px;
      font-size: 12px;
      line-height:1.25;
    }
    .grid4 .block b{
      display:block;
      margin-bottom:6px;
      letter-spacing:0.10em;
      text-transform:uppercase;
      color: var(--red);
      font-size:11px;
    }

    .compose{
      height: 56px;
      border-top: 3px solid #111;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 0 12px;
      background:#fff;
    }
    .input{
      flex:1;
      height: 34px;
      border:2px solid #111;
      box-shadow: 2px 2px 0 #111;
      padding: 0 10px;
      display:flex;
      align-items:center;
      font-size: 12px;
      color:#777;
    }
    .send{
      width: 92px;
      height: 34px;
      border:2px solid #111;
      box-shadow: 2px 2px 0 #111;
      background: var(--red);
      color:#fff;
      font-weight:900;
      letter-spacing:0.14em;
      text-transform:uppercase;
      font-size: 12px;
    }

    /* Random pixel slogans on desktop */
    .slogan{
      position:absolute;
      font-family:'Fira Code', monospace;
      font-size: 12px;
      font-weight:900;
      letter-spacing:0.10em;
      text-transform:uppercase;
      padding: 6px 8px;
      background:#fff;
      border:2px solid #111;
      box-shadow: 2px 2px 0 #111;
      color: var(--red);
      image-rendering: pixelated;
      white-space:nowrap;
      pointer-events:none;
      opacity:0;
      transform: translateY(2px);
    }
    .slogan.on{
      opacity:1;
      transform: translateY(0);
    }
    /* 12fps-ish transitions */
    body.mode-off .slogan{
      transition: opacity .20s steps(12,end), transform .20s steps(12,end);
    }

    /* ========= ON SCENE (TIMELINE) ========= */
    .on-scene{
      position:relative;
      inset:0;
      width:100%;
      height: calc(var(--vh, 1vh) * 100);
      z-index:60;
      transition: opacity .18s ease;
    }

    .bg-stage{
      position:fixed;
      inset:0;
      z-index:-10;
      overflow:hidden;
      background:#000;
    }
    .vid-wrap{
      position:absolute;
      inset:-12vh -12vw;
      transform:translateZ(0);
      will-change:transform,filter;
      filter: grayscale(1) contrast(1.12) brightness(.70);
    }
    .vid-wrap video{
      position:absolute;
      top:50%;
      left:50%;
      width:130vw;
      height:calc(130vw * 9 / 16);
      min-width:130vw;
      min-height:130vh;
      transform:translate(-50%,-50%);
      object-fit:cover;
      border:0;
      pointer-events:none;
    }
    .vignette{
      position:absolute;
      inset:0;
      z-index:2;
      pointer-events:none;
      background:
        radial-gradient(1100px 650px at 50% 45%,
          rgba(0,0,0,0.05),
          rgba(0,0,0,0.72) 70%,
          rgba(0,0,0,0.92));
    }

    .ascii-fire{
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      width:100vw;
      z-index:4;
      pointer-events:none;
      font-family: 'Fira Code', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight:500;
      line-height:1;
      white-space:pre;
      margin:0;
      padding:0; /* FIX #1: no bottom padding gap */
      color: var(--ui-accent);
      opacity:0.92;
      mix-blend-mode: screen;
      transform: translateZ(0);
      letter-spacing: 0.06em;
      font-size: clamp(10px, 1.15vw, 13px);
      text-align: left;
    }

    .year-display{
      position:absolute;
      inset:0;
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:8;
      perspective:1000px;
      pointer-events:none;
    }
    .huge-text{
      pointer-events:auto;
      cursor:pointer;
      font-family:'Anton',sans-serif;
      font-size:min(28.6vw, 286px);
      line-height:0.88;
      width:100vw;
      text-align:center;
      letter-spacing:-0.02em;
      text-transform:uppercase;
      position:absolute;
      white-space:nowrap;

      color: var(--red);
      -webkit-text-stroke: 0px transparent;
      text-shadow: none;

      transition: transform .8s cubic-bezier(.2,1,.3,1), opacity .65s cubic-bezier(.2,1,.3,1);
      will-change: transform, opacity;
    }
    .huge-text .ch{ display:inline-block; will-change: transform, opacity; }
    .huge-text.active .ch{ animation: chSnapIn 720ms cubic-bezier(.12,1,.22,1) both; }
    .huge-text.active .ch:nth-child(1){ animation-delay: 0ms; }
    .huge-text.active .ch:nth-child(2){ animation-delay: 40ms; }
    .huge-text.active .ch:nth-child(3){ animation-delay: 80ms; }
    .huge-text.active .ch:nth-child(4){ animation-delay: 120ms; }
    @keyframes chSnapIn{
      0%   { transform: translateY(32px) rotateX(42deg) scale(1.06); opacity:0; }
      55%  { transform: translateY(-6px) rotateX(0deg) scale(1.0); opacity:1; }
      100% { transform: translateY(0px) rotateX(0deg) scale(1.0); opacity:1; }
    }
    .huge-text.enter-right{ transform:translateX(58vw) rotateY(-18deg); opacity:0; }
    .huge-text.enter-left { transform:translateX(-58vw) rotateY(18deg); opacity:0; }
    .huge-text.active     { transform:translateX(0) rotateY(0); opacity:1; }
    .huge-text.exit-left  { transform:translateX(-58vw) rotateY(18deg); opacity:0; }
    .huge-text.exit-right { transform:translateX(58vw) rotateY(-18deg); opacity:0; }

    body.panel-open .huge-text.active{
      transform: translateY(-55vh) rotateX(22deg) scale(0.98);
      opacity: 0.0;
    }

    .center-panel{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%) scale(0.96);
      width: min(920px, 88vw);
      height: min(440px, 46vh);
      border-radius: 12px;
      z-index: 40;
      pointer-events: none;
      background: var(--panel-bg);
      border: 2px solid var(--panel-border);
      box-shadow:
        0 30px 120px rgba(0,0,0,0.55),
        0 0 0 2px rgba(0,0,0,0.16) inset;
      opacity: 0;
      will-change: transform, opacity;
    }
    body.panel-open .center-panel{ opacity: 1; animation: panelIn 720ms cubic-bezier(.12,1,.22,1) both; }
    @keyframes panelIn{
      0%   { transform: translate(-50%,-50%) scale(0.84) rotateX(10deg); opacity: 0; }
      55%  { transform: translate(-50%,-50%) scale(1.02) rotateX(0deg); opacity: 1; }
      100% { transform: translate(-50%,-50%) scale(1.00) rotateX(0deg); opacity: 1; }
    }
    .panel-grid{
      position:absolute; inset:0; border-radius:10px; pointer-events:none;
      opacity:0.30;
      background:
        linear-gradient(to right, rgba(0,0,0,0.28) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0,0,0,0.22) 1px, transparent 1px);
      background-size: 26px 26px;
      mix-blend-mode: multiply;
    }
    body.invert .panel-grid{
      background:
        linear-gradient(to right, rgba(255,46,46,0.22) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,46,46,0.18) 1px, transparent 1px);
      mix-blend-mode: normal;
      opacity:0.28;
    }
    .panel-content{
      position:absolute; inset:22px;
      display:flex; flex-direction:column; gap:14px;
      color: var(--panel-text);
    }
    .panel-kicker{
      font-size:12px; letter-spacing:0.22em;
      text-transform:uppercase; opacity:0.9;
      font-family:'Fira Code', monospace;
      font-weight:900;
    }
    .panel-title{
      font-size: clamp(26px, 3vw, 44px);
      line-height:1.02; letter-spacing:-0.02em;
      font-weight:900; text-transform:uppercase;
      font-family:'Inter', sans-serif;
    }
    .panel-body{
      font-size: clamp(14px, 1.25vw, 18px);
      line-height:1.35; max-width: 70ch; opacity:0.95;
      font-family:'Inter', sans-serif;
    }
    .panel-actions{
      margin-top:auto; display:flex; gap:12px; align-items:center;
    }
    .btn{
      pointer-events:none;
      display:inline-flex; align-items:center; justify-content:center;
      height:44px; padding:0 16px; border-radius:10px;
      border:2px solid rgba(0,0,0,0.35);
      background: rgba(0,0,0,0.18);
      color: var(--panel-text);
      font-weight:900; letter-spacing:0.12em;
      text-transform:uppercase; font-size:12px;
      font-family:'Fira Code', monospace;
    }
    body.invert .btn{
      border-color: rgba(255,46,46,0.55);
      background: rgba(255,46,46,0.10);
      color: rgba(255,46,46,0.98);
    }
    .panel-note{
      font-size:12px; letter-spacing:0.14em;
      text-transform:uppercase; opacity:0.85;
      font-family:'Fira Code', monospace;
      font-weight:900;
    }

    .thread-container{
      position:absolute; left:0; bottom:16vh;
      width:100%; height:26px; z-index:30;
      display:flex; justify-content:space-between; align-items:center;
      padding:0 10vw; box-sizing:border-box;
      pointer-events:none;
    }
    .thread-line{
      position:absolute; top:50%; left:10vw; right:10vw;
      height:2px; background: var(--ui-line); z-index:0;
    }
    .notch{
      width:10px; height:10px;
      background: rgba(0,0,0,0.35);
      border: 2px solid var(--ui-line);
      border-radius: 999px;
      position:relative; z-index:1;
      transition: all .25s ease;
    }
    .notch.active{
      background: var(--ui-primary);
      box-shadow: 0 0 0 2px rgba(0,0,0,0.25), 0 0 18px rgba(255,255,255,0.75);
      transform: scale(1.7);
      border-color: transparent;
    }

    .orb-cursor{
      position:absolute; left:50%;
      bottom: calc(16vh + 13px);
      width:78px; height:78px;
      transform: translate(-50%, 50%);
      z-index:60;
      cursor: grab;
      border-radius: 12px;
      background: rgba(0,0,0,0.26);
      border: 2px solid rgba(255,255,255,0.30);
      box-shadow:
        0 18px 60px rgba(0,0,0,0.55),
        inset 0 0 0 2px rgba(0,0,0,0.18);
      transition: width .18s, height .18s, transform .18s, border-color .18s;
      pointer-events:auto;
      display:flex; align-items:center; justify-content:center;
    }
    body.invert .orb-cursor{
      background: rgba(255,255,255,0.26);
      border-color: rgba(0,0,0,0.28);
    }
    .orb-cursor:active{
      cursor:grabbing;
      width:72px; height:72px;
      border-color: rgba(255,255,255,0.92);
    }
    .handle-icon{
      width:34px; height:34px; display:block;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.45));
    }
    .handle-icon .fill-accent{ fill: var(--ui-accent); }
    .handle-icon .fill-primary{ fill: var(--ui-primary); }

    .info-wrap{
      position:absolute;
      bottom: 23vh;
      left:0;
      width:100%;
      text-align:center;
      z-index:35;
      pointer-events:none;
    }
    .info-label{
      font-size:.78rem;
      letter-spacing:4px;
      text-transform:uppercase;
      color: var(--ui-muted);
      margin-bottom:.65rem;
      text-shadow:0 0 18px rgba(0,0,0,.55);
      font-family:'Fira Code', monospace;
      font-weight:900;
    }
    .info-title{
      font-size: clamp(20px, 2.2vw, 34px);
      font-weight:300;
      color: var(--ui-primary);
      opacity:0;
      transform: translateY(16px);
      transition: opacity .45s, transform .45s;
      text-shadow:0 0 30px rgba(0,0,0,.65);
      margin: 0;
    }
    .info-title.visible{ opacity:1; transform: translateY(0); }
    .info-desc{
      margin: 10px auto 0;
      max-width: min(72ch, 86vw);
      font-size: clamp(13px, 1.1vw, 16px);
      line-height: 1.35;
      color: var(--ui-muted);
      opacity: 0;
      transform: translateY(12px);
      transition: opacity .45s, transform .45s;
      text-shadow: 0 0 24px rgba(0,0,0,0.55);
    }
    .info-desc.visible{ opacity: 1; transform: translateY(0); }

    @media (max-width: 560px){
      :root{
        --switch-w: 156px;
        --switch-h: 14px;
      }
      .topbar{ top: 12px; left: 12px; }
      .ios-switch .label{ font-size: 9px; gap:6px; }
      .messenger-body{ grid-template-columns: 1fr; }
      .sidebar{ border-right:0; border-bottom:3px solid #111; }
      .thread-container{ bottom: 15vh; }
      .orb-cursor{ bottom: calc(15vh + 13px); width:70px; height:70px; }
      .info-wrap{ bottom: 22vh; }
      .huge-text{ font-size: 34vw; }
      .center-panel{ height: min(460px, 54vh); border-radius: 10px; }
      .panel-content{ inset:18px; }
      .ascii-fire{ font-size: 11px; letter-spacing: 0.08em; }
    }

    .track,
    .thumb{
      box-shadow: none !important;
    }

    /* OFF mode тоже без пиксельной тени */
    body.mode-off .track,
    body.mode-off .thumb{
      box-shadow: none !important;
    }

    /* =========================================================
       iPad/iPhone: keep desktop layout + bump minimum readability
       (doesn't touch animations/logic; only overrides small-screen reflow)
       ========================================================= */
    body.mobile-desktop{
      -webkit-text-size-adjust:100%;
    }
    body.mobile-desktop .topbar{ top:14px; left:14px; }

    body.mobile-desktop .messenger-body{ grid-template-columns: 320px 1fr; }
    body.mobile-desktop .sidebar{ border-right: 3px solid #111; border-bottom:0; }
    body.mobile-desktop .thread-container{ bottom:16vh; }
    body.mobile-desktop .orb-cursor{ bottom: calc(16vh + 13px); width:78px; height:78px; }
    body.mobile-desktop .info-wrap{ bottom: 23vh; }
    body.mobile-desktop .huge-text{ font-size:min(28.6vw, 286px); }
    body.mobile-desktop .center-panel{ height: min(440px, 46vh); border-radius: 12px; }
    body.mobile-desktop .panel-content{ inset:22px; }
    body.mobile-desktop .ascii-fire{ font-size: clamp(10px, 1.15vw, 13px); letter-spacing: 0.06em; }

    /* readability bump for presentation on small physical screens (desktop look preserved) */
    body.mobile-desktop .info-label{ font-size: 12px; letter-spacing: 4px; }
    body.mobile-desktop .info-desc{ font-size: clamp(14px, 1.1vw, 16px); }
    body.mobile-desktop .panel-kicker{ font-size: 13px; }
    body.mobile-desktop .panel-body{ font-size: clamp(16px, 1.25vw, 18px); }
    body.mobile-desktop .btn{ font-size: 13px; }
    body.mobile-desktop .panel-note{ font-size: 13px; }

    body.mobile-desktop .pixel-taskbar{ font-size: 13px; }
    body.mobile-desktop .pane-title{ font-size: 13px; }
    body.mobile-desktop .pane-card{ font-size: 13px; }
    body.mobile-desktop .tab{ font-size: 13px; }
    body.mobile-desktop .grid4 .block{ font-size: 13px; }

    /* =========================================================
       FIX #3: iPhone landscape anti-overlap (small height)
       ========================================================= */
    @media (max-height: 430px) and (orientation: landscape){
      .thread-container{ bottom: 10vh; }
      .orb-cursor{ bottom: calc(10vh + 13px); width:70px; height:70px; }
      .info-wrap{ bottom: 15vh; }
      .huge-text{ font-size: min(26vw, 240px); }
      body.panel-open .huge-text.active{
        transform: translateY(-48vh) rotateX(18deg) scale(0.98);
      }
      .center-panel{ height: min(360px, 56vh); }
      .panel-content{ inset:18px; }
      .panel-title{ font-size: clamp(22px, 3vw, 38px); }
      .panel-body{ font-size: clamp(14px, 1.25vw, 16px); }
    }
  </style>
</head>

<body class="mode-on">

  <!-- SWITCH -->
  <div class="topbar">
    <div class="ios-switch" id="modeSwitch" data-state="on" aria-label="Mode switch">
      <div class="label">
        <span class="off">OFF</span>
        <span class="on">ON</span>
      </div>
      <div class="track">
        <div class="thumb"></div>
        <button class="track-btn" id="switchBtn" aria-label="Toggle"></button>
      </div>
    </div>
  </div>

  <!-- OFF SCENE -->
  <div class="off-scene" id="offScene" aria-hidden="true">
    <div class="pixel-desktop" id="pixelDesktop"></div>

    <div class="messenger-window">
      <div class="messenger-titlebar">
        PIXEL MESSENGER
        <div class="win-dots">
          <div class="dot"></div>
          <div class="dot red"></div>
          <div class="dot"></div>
        </div>
      </div>

      <div class="messenger-body">
        <div class="sidebar" id="tabs">
          <div class="tab active" data-tab="q">Исследовательские вопросы</div>
          <div class="tab" data-tab="e">Эмпирические данные</div>
          <div class="tab" data-tab="m">Метод</div>
          <div class="tab" data-tab="u">Уникальные характеристики протестных сообщений</div>
          <div class="tab" data-tab="i">Выявлена инфраструктура кибер-мобилизации</div>
          <div class="tab" data-tab="l">Выявлены лидеры движения "Youth Against Corruption"</div>
          <div class="tab" data-tab="h">Горизонтальные практики взаимного обучения</div>
        </div>

        <div class="pane" id="pane">
          <!-- injected by JS -->
        </div>
      </div>

      <div class="compose">
        <div class="input">type a message…</div>
        <button class="send" type="button">SEND</button>
      </div>
    </div>

    <div class="pixel-taskbar">
      <div class="pixel-start">MENU</div>
      <div>PIXEL DESKTOP</div>
      <div class="pixel-clock" id="pixelClock">00:00</div>
    </div>
  </div>

  <!-- ON SCENE -->
  <div class="on-scene" id="onScene">
    <div class="bg-stage" aria-hidden="true">
      <div class="vid-wrap" id="vidWrap">
        <video id="bgVideo" autoplay muted loop playsinline preload="auto">
          <source src="BG.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="vignette"></div>
      <pre class="ascii-fire" id="asciiFire"></pre>
    </div>

    <div class="center-panel" id="centerPanel" aria-hidden="true">
      <div class="panel-grid"></div>
      <div class="panel-content">
        <div class="panel-kicker" id="panelKicker">ALERT / 7-STEP TIMELINE</div>
        <div class="panel-title" id="panelTitle">STREET SIGNALS<br>INFORMATION WAR</div>
        <div class="panel-body" id="panelBody">…</div>
        <div class="panel-actions">
          <div class="btn">CONTINUE</div>
          <div class="panel-note">ESC / CLICK — CLOSE</div>
        </div>
      </div>
    </div>

    <div class="year-display" id="yearContainer"></div>

    <div class="thread-container">
      <div class="thread-line"></div>
      <div class="notch" id="n0"></div>
      <div class="notch" id="n1"></div>
      <div class="notch" id="n2"></div>
      <div class="notch" id="n3"></div>
      <div class="notch" id="n4"></div>
      <div class="notch" id="n5"></div>
      <div class="notch" id="n6"></div>
    </div>

    <div class="orb-cursor" id="orb" aria-label="drag handle">
      <svg class="handle-icon" viewBox="0 0 64 64" aria-hidden="true">
        <path class="fill-primary" d="M49 8l3 9 9 3-9 3-3 9-3-9-9-3 9-3 3-9z" opacity="0.95"/>
        <path class="fill-accent" d="M31.8 58c-10.7 0-19.4-8.2-19.4-18.3 0-7.2 4.1-12.6 10.4-18.6 2.8-2.7 3.6-6.2 3.8-9.1.2-2.7 0-5.2 0-5.2s8.7 6 11.3 13.6c.7 2.1 1.1 4.4 1 6.5 2.6-2 4-4.8 4-4.8s7.3 6.3 7.3 16.7C50.2 50 42 58 31.8 58z"/>
        <path class="fill-primary" d="M31.6 53.2c-6.8 0-12.3-5.2-12.3-11.6 0-4.8 2.8-8.4 6.8-12.2 2.2-2.1 3-4.7 3.2-7.2 3.1 2.8 5.4 6.9 5.4 11.2 0 1.6-.3 3.1-.9 4.5 2-1 3.4-2.6 4.3-4.4 1.8 2.5 2.7 5.3 2.7 8.1 0 6.4-5.5 11.6-12.2 11.6z" opacity="0.92"/>
      </svg>
    </div>

    <div class="info-wrap">
      <div class="info-label" id="label">TIMELINE</div>
      <h1 class="info-title" id="infoTitle"></h1>
      <p class="info-desc" id="infoDesc"></p>
    </div>
  </div>

  <script>
    // ===== iOS/iPad: keep desktop layout + stable viewport height (no logic changes) =====
    (function(){
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
        (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      if (isIOS) document.body.classList.add('mobile-desktop');

      function setVhVar(){
        const h = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight;
        document.documentElement.style.setProperty('--vh', (h * 0.01) + 'px');
      }
      setVhVar();
      window.addEventListener('resize', setVhVar);
      if (window.visualViewport) window.visualViewport.addEventListener('resize', setVhVar);
    })();

    // ========= FPS CONTROL (old OS vibe) =========
    const OFF_FPS = 12;
    const OFF_TICK_MS = Math.round(1000 / OFF_FPS); // ~83ms

    // ========= SWITCH / MODES =========
    const modeSwitch = document.getElementById('modeSwitch');
    const switchBtn = document.getElementById('switchBtn');

    function setMode(on) {
      const state = on ? "on" : "off";
      modeSwitch.setAttribute("data-state", state);
      document.body.classList.toggle("mode-on", on);
      document.body.classList.toggle("mode-off", !on);

      if (bgVideo) {
        if (on) { forcePlay(); }
        else { try { bgVideo.pause(); } catch(e){} }
      }

      // OFF-only loops
      if (!on) startOffLoops();
      else stopOffLoops();
    }

    switchBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const isOn = modeSwitch.getAttribute("data-state") === "on";
      setMode(!isOn);
    });

    // Pixel clock
    const pixelClock = document.getElementById('pixelClock');
    function pad2(n){ return String(n).padStart(2,'0'); }
    function tickClock(){
      const d = new Date();
      pixelClock.textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }
    tickClock();
    setInterval(tickClock, 1000);

    // ========= OFF TABS CONTENT =========
    const pane = document.getElementById('pane');
    const tabsWrap = document.getElementById('tabs');

    const tabContent = {
      q: `
        <div class="pane-title">Исследовательские вопросы</div>
        <div class="pane-card">
          1) Как устроена циркуляция протестных сообщений между платформами?<br><br>
          2) Какие признаки позволяют отличить “органический” рост от управляемой мобилизации?<br><br>
          3) Как меняется язык призывов при переходе от локальной повестки к общему движению?
        </div>
      `,
      e: `
        <div class="pane-title">Эмпирические данные</div>
        <div class="pane-card">
          Корпус сообщений и постов; временные ряды активности; сетевые графы взаимодействия;
          выборки по ключевым тегам и узлам распространения; медиавложения и метаданные публикаций.
        </div>
      `,
      m: `
        <div class="pane-title">Метод</div>
        <div class="pane-card">
          Сбор → очистка → разметка → анализ.
          <ul class="pixel-bullets">
            <li>Контент-анализ (мотивы, риторика, фреймы)</li>
            <li>Сетевой анализ (узлы, мосты, кластеры)</li>
            <li>Темпоральный анализ (волны, триггеры, отклики)</li>
            <li>Качественная проверка кейсами (ручные срезы)</li>
          </ul>
        </div>
      `,
      u: `
        <div class="pane-title">Уникальные характеристики протестных сообщений</div>
        <div class="pane-card">
          Короткие формулы → меметичность → “инструкции” → микро-ритуалы → переводы между платформами.
          <div class="ticker" aria-hidden="true">
            <div class="track">
              <div class="ticker-line">
                СООБЩЕНИЕ=СИГНАЛ • МЕМ=ИНСТРУКЦИЯ • РЕПОСТ=МАРШРУТ • ТЕГ=КООРДИНАТЫ • СООБЩЕНИЕ=СИГНАЛ • МЕМ=ИНСТРУКЦИЯ • РЕПОСТ=МАРШРУТ • ТЕГ=КООРДИНАТЫ •
              </div>
            </div>
          </div>
        </div>
      `,
      i: `
        <div class="pane-title">Выявлена инфраструктура кибер-мобилизации</div>
        <div class="pane-card">
          Контуры ретрансляции, “переводчики” повестки, узлы дублирования, расписания публикаций,
          точки синхронизации и периоды усиления. Повторяющийся маршрут: ядро → периферия → локальные сборки.
        </div>
      `,
      l: `
        <div class="pane-title">Выявлены лидеры "Youth Against Corruption"</div>
        <div class="pane-card">
          Стабильные хабы распространения и организаторы “мостов” между кластерами:
          аккаунты/каналы, которые (а) первыми запускают формулировки, (б) получают максимум ранних репостов,
          (в) соединяют разрозненные группы в общую сеть.<br><br>
          Дополнительно: выделены роли “курьеров” (переносят сообщения между платформами)
          и “сборщиков” (консолидируют повестку в понятный пакет).
        </div>
      `,
      h: `
        <div class="pane-title">Горизонтальные практики взаимного обучения</div>
        <div class="pane-card">
          Взаимное обучение работает как набор простых модулей, которые люди передают друг другу “вручную”.
          <div class="grid4">
            <div class="block"><b>Шаблоны</b>Короткие тексты, которые легко копируются и адаптируются под локальный контекст.</div>
            <div class="block"><b>Навигация</b>“Куда идти / что делать / как не потеряться” — краткие правила и маршруты.</div>
            <div class="block"><b>Координация</b>Мини-протоколы: время, место, сигнал, проверка, запасной план.</div>
            <div class="block"><b>Поддержка</b>Памятки, взаимопомощь, распределение задач без иерархий.</div>
          </div>
        </div>
      `
    };

    function renderTab(key){
      pane.innerHTML = tabContent[key] || `<div class="pane-title">…</div><div class="pane-card">Нет данных.</div>`;
    }

   function activateTabFromEvent(e){
  const t = e.target.closest('.tab');
  if(!t) return;

  // важно для iOS landscape: срезаем "жест" и гарантируем обработку
  if (e.cancelable) e.preventDefault();
  e.stopPropagation();

  const key = t.getAttribute('data-tab');
  Array.from(tabsWrap.querySelectorAll('.tab')).forEach(el => el.classList.toggle('active', el === t));
  renderTab(key);
}

// iOS/Safari: pointerdown/touchstart срабатывают стабильнее, чем click
tabsWrap.addEventListener('pointerdown', activateTabFromEvent, { passive:false });
tabsWrap.addEventListener('touchstart', activateTabFromEvent, { passive:false });

// fallback
tabsWrap.addEventListener('click', activateTabFromEvent);


    // default OFF pane content
    renderTab('q');

    // ========= OFF RANDOM SLOGANS (12fps-ish) =========
    const pixelDesktop = document.getElementById('pixelDesktop');

    const slogans = [
      "NO CAP",
      "BASED",
      "TOUCH GRASS",
      "WE MOVE",
      "СТОЙКОСТЬ",
      "СВОБОДА ДЛЯ ВСЕХ",
      "ПРАВА НЕ ТИШИНА",
      "ГОЛОС ИМЕЕТ ЗНАЧЕНИЕ",
      "НЕ НОРМА • НЕ ОК",
      "WE SEE YOU",
      "SAY IT LOUD",
      "KEEP SIGNAL",
      "ДЕРЖИ СИГНАЛ"
    ];

    let offLoopTimer = null;
    let offSloganTimer = null;

    function quantizedTimeout(fn, ms){
      const steps = Math.max(1, Math.round(ms / OFF_TICK_MS));
      return setTimeout(fn, steps * OFF_TICK_MS);
    }

    function spawnSlogan(){
      if (!document.body.classList.contains('mode-off')) return;

      const el = document.createElement('div');
      el.className = 'slogan';
      el.textContent = slogans[(Math.random() * slogans.length) | 0];

      // safe placement
      const pad = 18;
      const w = window.innerWidth;
      const h = window.innerHeight;

      const maxX = Math.max(pad, w - pad - 220);
      const maxY = Math.max(pad, h - pad - 120);

      const x = Math.floor(pad + Math.random() * (maxX - pad));
      const y = Math.floor(pad + Math.random() * (maxY - pad));

      el.style.left = x + "px";
      el.style.top  = y + "px";

      pixelDesktop.appendChild(el);

      // show with quantized "old OS" feel
      quantizedTimeout(() => el.classList.add('on'), OFF_TICK_MS);

      // hide & remove
      quantizedTimeout(() => el.classList.remove('on'), 1800 + Math.random()*900);
      quantizedTimeout(() => { if(el.parentNode) el.remove(); }, 2400 + Math.random()*900);
    }

    function startOffLoops(){
      if (offLoopTimer) return;

      // occasional slogans
      offSloganTimer = setInterval(() => {
        if (Math.random() < 0.62) spawnSlogan();
      }, 900);

    }

    function stopOffLoops(){
      if (offLoopTimer){ clearInterval(offLoopTimer); offLoopTimer = null; }
      if (offSloganTimer){ clearInterval(offSloganTimer); offSloganTimer = null; }
      const msgWin = document.querySelector('.messenger-window');
      if (msgWin) msgWin.style.transform = "translate(-50%,-50%)";
    }

    // ========= TIMELINE DATA (ON MODE) =========
    const FIRE_WIDTH_MULT = 1.55;
    const FIRE_MAX_COLS = 360;

    const data = [
      { year: "2018", title: "SEED / ЗАРОЖДЕНИЕ", desc: "Первые искры: разрозненные группы, локальные поводы, поиск языка и символов.", panelTitle: "SEED SIGNALS", panelBody: "Низкий порог входа. Много шума, мало координации. Главное — сформировать узнаваемый визуальный код и ритм действий." },
      { year: "2019", title: "IGNITION / ИМПУЛЬС", desc: "Ускорение: общие точки сборки, повторяемые сценарии, резонансные триггеры.", panelTitle: "IGNITION PHASE", panelBody: "Появляются регулярные всплески и первые устойчивые каналы. Цена ошибки растёт, но растёт и масштаб." },
      { year: "2020", title: "SHIFT / ПОВОРОТ", desc: "Смена режима: новые каналы, новые риски, новая скорость распространения сигналов.", panelTitle: "SHIFT / RECODE", panelBody: "Перенастройка тактик. Информация становится топливом. Важнее не громкость, а синхронизация." },
      { year: "2021", title: "GENESIS / ИСТОКИ", desc: "Сборка структуры: роли, протоколы, инфраструктура выживания и устойчивости.", panelTitle: "GENESIS STRUCTURE", panelBody: "Фиксируются правила игры: кто говорит, кто собирает, кто держит контур. Без этого всё распадается." },
      { year: "2022", title: "EXPANSION / РОСТ", desc: "Расширение: география, аудитория, сложность коалиций, уровень наблюдения.", panelTitle: "EXPANSION PRESSURE", panelBody: "Чем шире сеть, тем сложнее контроль. Нужны простые, масштабируемые ритуалы и интерфейсы." },
      { year: "2023", title: "SYNERGY / СИНТЕЗ", desc: "Синтез: коалиции, совместные действия, общая грамматика визуала и поведения.", panelTitle: "SYNERGY / MERGE", panelBody: "Движение становится платформой. Успех зависит от совместимости: символов, каналов, темпа." },
      { year: "2024", title: "FUTURE / ЗАВТРА", desc: "Будущее: сценарии эскалации/затухания. Выбор между вспышкой и долгим тлением.", panelTitle: "FUTURE EDGE", panelBody: "Ставка на устойчивость или на резкий рывок. В обоих случаях решает дисциплина и ясный дизайн сигналов." }
    ];

    let currentIndex = 0;
    let isDragging = false;
    let startX = 0;
    let currentX = 0;
    let isAnimating = false;

    const orb = document.getElementById('orb');
    const yearContainer = document.getElementById('yearContainer');
    const infoTitle = document.getElementById('infoTitle');
    const infoDesc  = document.getElementById('infoDesc');
    const asciiFireEl = document.getElementById('asciiFire');

    const panelTitleEl = document.getElementById('panelTitle');
    const panelBodyEl  = document.getElementById('panelBody');

    const notches = Array.from({length: data.length}, (_, i) => document.getElementById('n' + i));

    let TRIGGER_DIST = window.innerWidth * 0.14;
    let MAX_DRAG = window.innerWidth * 0.24;

    window.addEventListener('resize', () => {
      TRIGGER_DIST = window.innerWidth * 0.14;
      MAX_DRAG = window.innerWidth * 0.24;
      fireResize(true);
    });

    function splitChars(text) {
      return Array.from(text).map(ch => `<span class="ch">${ch}</span>`).join('');
    }

    function updateNotches(idx) {
      notches.forEach((n, i) => n && n.classList.toggle('active', i === idx));
    }

    function updateInfo(index){
      infoTitle.classList.remove('visible');
      infoDesc.classList.remove('visible');
      setTimeout(() => {
        infoTitle.textContent = data[index].title || "";
        infoDesc.textContent = data[index].desc || "";
        infoTitle.classList.add('visible');
        infoDesc.classList.add('visible');
      }, 240);
    }

    function updatePanelCopy(index){
      panelTitleEl.innerHTML = (data[index].panelTitle || "STREET SIGNALS").replace(/\n/g, "<br>");
      panelBodyEl.textContent = data[index].panelBody || "";
    }

    function renderYear(index, stateClass) {
      const old = yearContainer.querySelector('.active');
      if (old) {
        if (stateClass === 'enter-right') old.className = 'huge-text exit-left';
        else if (stateClass === 'enter-left') old.className = 'huge-text exit-right';
        else old.remove();
        setTimeout(() => { if (old.parentNode) old.remove(); }, 800);
      }

      const el = document.createElement('div');
      el.className = `huge-text ${stateClass}`;
      el.innerHTML = splitChars(data[index].year);

      el.addEventListener('click', (e) => {
        e.stopPropagation();
        togglePanel();
      });

      yearContainer.appendChild(el);

      requestAnimationFrame(() => {
        el.classList.remove(stateClass);
        el.classList.add('active');
      });
    }

    function changeSlide(direction) {
      if (isAnimating) return;
      if (document.body.classList.contains('panel-open')) return;
      if (document.body.classList.contains('mode-off')) return;
      isAnimating = true;

      let nextIndex = currentIndex + direction;
      if (nextIndex >= data.length) nextIndex = 0;
      if (nextIndex < 0) nextIndex = data.length - 1;

      const animationClass = direction > 0 ? 'enter-right' : 'enter-left';
      renderYear(nextIndex, animationClass);
      updateNotches(nextIndex);
      updateInfo(nextIndex);
      updatePanelCopy(nextIndex);

      currentIndex = nextIndex;
      setFireTargetByIndex(currentIndex);

      setTimeout(() => { isAnimating = false; }, 800);
    }

    function togglePanel(forceClose = false) {
      const open = document.body.classList.contains('panel-open');
      if (forceClose || open) {
        document.body.classList.remove('panel-open');
        document.body.classList.remove('invert');
        return;
      }
      document.body.classList.add('panel-open');
      document.body.classList.add('invert');
    }

    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') togglePanel(true);
    });

    window.addEventListener('pointerdown', () => {
      if (document.body.classList.contains('panel-open')) togglePanel(true);
    });

    orb.addEventListener('pointerdown', (e) => e.stopPropagation());

    // --- PHYSICS LOOP ---
    let orbX = 0;
    let velocity = 0;
    const stiffness = 0.085;
    const damping = 0.76;

    function animateOrb() {
      if (!isDragging) {
        const force = (0 - orbX) * stiffness;
        velocity += force;
        velocity *= damping;
        orbX += velocity;
      } else {
        const diff = currentX - orbX;
        orbX += diff * 0.22;
      }
      orb.style.transform = `translate(calc(-50% + ${orbX}px), 50%)`;
      requestAnimationFrame(animateOrb);
    }
    animateOrb();

    function onStart(x) {
      if (isAnimating) return;
      if (document.body.classList.contains('panel-open')) return;
      if (document.body.classList.contains('mode-off')) return;
      isDragging = true;
      startX = x;
      document.body.style.cursor = 'grabbing';
    }

    function onMove(x) {
      if (!isDragging) return;
      let delta = x - startX;

      const limit = MAX_DRAG;
      const sign = Math.sign(delta);
      const abs = Math.abs(delta);
      const damped = sign * limit * Math.log10(1 + (abs / limit) * 9);
      currentX = damped;
    }

    function onEnd() {
      if (!isDragging) return;
      isDragging = false;
      document.body.style.cursor = 'default';

      if (Math.abs(orbX) > TRIGGER_DIST) {
        if (orbX > 0) changeSlide(1);
        else changeSlide(-1);
      }
      currentX = 0;
    }

    orb.addEventListener('mousedown', e => onStart(e.clientX));
    window.addEventListener('mousemove', e => onMove(e.clientX));
    window.addEventListener('mouseup', onEnd);

    orb.addEventListener('touchstart', e => { e.preventDefault(); onStart(e.touches[0].clientX); }, { passive:false });

    // FIX #2: don't globally preventDefault touchmove (it breaks OFF tabs in iPhone landscape)
    window.addEventListener('touchmove', e => {
      if (!isDragging) return;
      e.preventDefault();
      onMove(e.touches[0].clientX);
    }, { passive:false });

    window.addEventListener('touchend', onEnd);

    // ===== Ensure local video plays =====
    const bgVideo = document.getElementById('bgVideo');
    function forcePlay() {
      if (!bgVideo) return;
      bgVideo.muted = true;
      const p = bgVideo.play();
      if (p && typeof p.catch === "function") p.catch(()=>{});
    }
    forcePlay();
    setTimeout(forcePlay, 250);
    setTimeout(forcePlay, 900);
    window.addEventListener('pointerdown', forcePlay, { once:true });
    window.addEventListener('touchstart', forcePlay, { once:true, passive:true });

    // =========================
    // ASCII FIRE
    // =========================
    let fireCols = 0;
    let fireRowsBase = 0;
    let fireRows = 0;
    let fireTargetRows = 0;
    let fireField = null;

    const ramp = [" ", " ", ".", ":", "-", "=", "+", "*", "#", "@"];

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    function fireResize(forceReinit=false) {
      const approxCharW = 9;
      const cols = clamp(
        Math.floor((window.innerWidth / approxCharW) * FIRE_WIDTH_MULT),
        140,
        FIRE_MAX_COLS
      );

      const approxLineH = 12;
      const basePx = window.innerHeight * 0.05;
      const baseRows = clamp(Math.floor(basePx / approxLineH), 6, 22);

      fireCols = cols;
      fireRowsBase = baseRows;
      fireTargetRows = computeTargetRows(currentIndex);

      if (forceReinit || !fireField) {
        fireRows = fireTargetRows;
        initFireField(Math.round(fireRows), fireCols);
      }
    }

    function computeTargetRows(idx) {
      const r = fireRowsBase * (1 + idx);
      return clamp(r, fireRowsBase, fireRowsBase * data.length);
    }

    function setFireTargetByIndex(idx){
      fireTargetRows = computeTargetRows(idx);
    }

    function initFireField(rows, cols){
      fireField = new Uint16Array(rows * cols);
      const maxI = ramp.length - 1;
      const base = (rows-1) * cols;
      for (let x=0; x<cols; x++){
        fireField[base + x] = (Math.random() < 0.22) ? (maxI - 2) : maxI;
      }
    }

    function ensureFireSize() {
      const desiredRows = Math.max(1, Math.round(fireRows));
      const currentRows = fireField ? Math.floor(fireField.length / fireCols) : 0;
      if (!fireField || desiredRows !== currentRows) initFireField(desiredRows, fireCols);
    }

    function fireStep() {
      if (!fireField) return;
      const rows = Math.floor(fireField.length / fireCols);
      const cols = fireCols;
      const maxI = ramp.length - 1;

      const base = (rows-1) * cols;
      const gapChance = 0.24 + (currentIndex * 0.02);
      for (let x=0; x<cols; x++){
        if (Math.random() < gapChance) fireField[base + x] = maxI - 3;
        else fireField[base + x] = maxI;
      }

      const decayMax = currentIndex <= 1 ? 3 : 2;
      for (let y=0; y<rows-1; y++){
        for (let x=0; x<cols; x++){
          const src = (y+1)*cols + x;
          const heat = fireField[src];

          const decay = (Math.random() * (decayMax + 1)) | 0;
          const drift = ((Math.random() * 3) | 0) - 1;
          const nx = clamp(x + drift, 0, cols-1);
          const dst = y*cols + nx;

          const out = heat > decay ? (heat - decay) : 0;
          fireField[dst] = out;
        }
      }
    }

    function fireRender() {
      if (!fireField) return;
      const rows = Math.floor(fireField.length / fireCols);
      const cols = fireCols;

      const readabilityBias = currentIndex === 0 ? 2 : (currentIndex === 1 ? 1 : 0);

      let out = "";
      for (let y=0; y<rows; y++){
        const rowOff = y*cols;
        for (let x=0; x<cols; x++){
          let v = fireField[rowOff + x];
          v = clamp(v - readabilityBias, 0, ramp.length - 1);
          out += ramp[v] || " ";
        }
        if (y !== rows-1) out += "\n";
      }
      asciiFireEl.textContent = out;
    }

    function fireTick() {
      if (document.body.classList.contains('mode-on')) {
        fireRows += (fireTargetRows - fireRows) * 0.12;
        if (Math.abs(fireTargetRows - fireRows) < 0.35) fireRows = fireTargetRows;

        ensureFireSize();
        fireStep();
        fireRender();
      }
      requestAnimationFrame(fireTick);
    }

    function init() {
      renderYear(0, 'active');
      updateNotches(0);
      updateInfo(0);
      updatePanelCopy(0);

      fireResize(true);
      setFireTargetByIndex(0);
      fireTick();

      // Default: ON
      setMode(true);
    }

    init();
  </script>
</body>
</html>
