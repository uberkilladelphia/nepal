<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Infinite Time Thread</title>

  <!-- PWA (works “no address bar” when installed as app / added to Home Screen) -->
  <meta name="theme-color" content="#050505" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Infinite Time Thread" />

  <!-- Inline manifest (data URL) -->
  <link rel="manifest" href='data:application/manifest+json,%7B%22name%22%3A%22Infinite%20Time%20Thread%22%2C%22short_name%22%3A%22TimeThread%22%2C%22start_url%22%3A%22.%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23050505%22%2C%22theme_color%22%3A%22%23050505%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%253D%2527http%253A%252F%252Fwww.w3.org%252F2000%252Fsvg%2527%2520viewBox%253D%25270%25200%2520256%2520256%2527%253E%253Crect%2520width%253D%2527256%2527%2520height%253D%2527256%2527%2520rx%253D%252756%2527%2520fill%253D%2527%2523050505%2527%252F%253E%253Cpath%2520d%253D%2527M130%2520228c-44%25200-80-34-80-76%25200-30%252017-53%252043-78%252012-12%252016-28%252017-41%25201-12%25200-24%25200-24s36%252025%252047%252056c3%25209%25205%252018%25204%252027%252011-9%252017-20%252017-20s30%252026%252030%252068c0%252045-34%252088-78%252088z%2527%2520fill%253D%2527%2523FF2E2E%2527%252F%253E%253Cpath%2520d%253D%2527M128%2520206c-28%25200-50-21-50-47%25200-19%252011-33%252028-48%252010-10%252012-19%252013-28%252013%25200%252023%252021%252030%252045c0%25207-2%252014-5%252020%25208-4%252014-11%252018-19%25207%252010%252011%252021%252011%252033%25200%252026-23%252047-50%252047z%2527%2520fill%253D%2527%2523FFFFFF%2527%2520opacity%253D%25270.9%2527%252F%253E%253C%252Fsvg%253E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%2C%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%253D%2527http%253A%252F%252Fwww.w3.org%252F2000%252Fsvg%2527%2520viewBox%253D%25270%25200%2520256%2520256%2527%253E%253Crect%2520width%253D%2527256%2527%2520height%253D%2527256%2527%2520rx%253D%252756%2527%2520fill%253D%2527%2523050505%2527%252F%253E%253Cpath%2520d%253D%2527M130%2520228c-44%25200-80-34-80-76%25200-30%252017-53%252043-78%252012-12%252016-28%252017-41%25201-12%25200-24%25200-24s36%252025%252047%252056c3%25209%25205%252018%25204%252027%252011-9%252017-20%252017-20s30%252026%252030%252068c0%252045-34%252088-78%252088z%2527%2520fill%253D%2527%2523FF2E2E%2527%252F%253E%253Cpath%2520d%253D%2527M128%2520206c-28%25200-50-21-50-47%25200-19%252011-33%252028-48%252010-10%252012-19%252013-28%252013%25200%252023%252021%252030%252045c0%25207-2%252014-5%252020%25208-4%252014-11%252018-19%25207%252010%252011%252021%252011%252033%25200%252026-23%252047-50%252047z%2527%2520fill%253D%2527%2523FFFFFF%2527%2520opacity%253D%25270.9%2527%252F%253E%253C%252Fsvg%253E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D' />

  <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20viewBox%3D%270%200%20128%20128%27%3E%3Crect%20width%3D%27128%27%20height%3D%271128%27%20rx%3D%2732%27%20fill%3D%27%23050505%27%2F%3E%3Cpath%20d%3D%27M65%20114c-22%200-40-17-40-38%200-15%209-27%2021-39%206-6%208-14%208-20%200-6%200-12%200-12s18%2013%2024%2028c2%204%203%209%202%2014%206-4%2010-10%2010-10s15%2013%2015%2034c0%2023-17%2043-40%2043z%27%20fill%3D%27%23FF2E2E%27%2F%3E%3Cpath%20d%3D%27M64%20103c-14%200-25-10-25-23%200-10%206-16%2014-24%205-5%206-10%207-14%200%200%2011%2010%2015%2022c0%203-1%206-2%209%204-2%207-5%209-9%203%204%205%2010%205%2016%200%2013-11%2023-23%2023z%27%20fill%3D%27%23FFFFFF%27%20opacity%3D%270.9%27%2F%3E%3C%2Fsvg%3E" />

  <link rel="preconnect" href="https://fonts.googleapis.com/">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Anton&family=Fira+Code:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#050505;
      --white:#ffffff;
      --red:#FF2E2E;

      --ui-primary: var(--white);
      --ui-accent: var(--red);
      --ui-muted: rgba(255,255,255,.62);
      --ui-line: rgba(255,255,255,.22);

      --panel-bg: rgba(255,46,46,0.88);
      --panel-border: rgba(255,255,255,0.60);
      --panel-text: rgba(255,255,255,0.98);

      --switch-w: 168px;
      --switch-h: 16px;
      --switch-pad: 2px;

      --off-ink: #111;
      --off-bg: #f6f6f6;

      --dot: 18px;
      --flame: 30px;

      /* lift years up to avoid collision with info/timeline */
      --year-lift: 14vh;
    }

    html{
      height:100%;
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
    }

    body{
      margin:0;
      overflow:hidden;
      height: calc(var(--vh, 1vh) * 100);
      width:100vw;
      background:var(--bg);
      font-family:'Inter',sans-serif;
      user-select:none;
      -webkit-user-select:none;
      cursor: default;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior: none;
      touch-action: manipulation;
    }

    body.invert{
      --ui-primary: var(--red);
      --ui-accent: var(--white);

      --panel-bg: rgba(255,255,255,0.90);
      --panel-border: rgba(0,0,0,0.30);
      --panel-text: rgba(255,46,46,0.98);
    }

    /* ========= SMALL SWITCH (TOP-LEFT) ========= */
    .topbar{
      position:fixed;
      top:14px;
      left:14px;
      z-index:200;
      pointer-events:auto;
    }

    .ios-switch{
      width: var(--switch-w);
      height: var(--switch-h);
      display:flex;
      align-items:center;
      gap:10px;
      pointer-events:auto;
    }

    .ios-switch .label{
      font-size: 10px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.80);
      display:flex;
      gap:8px;
      align-items:center;
      pointer-events:none;
      line-height:1;
      font-family: 'Fira Code', monospace;
      font-weight:700;
    }

    .ios-switch .label span{
      opacity:0.55;
      transition: opacity .18s steps(12,end), color .18s steps(12,end);
    }
    .ios-switch[data-state="on"] .label .on{ opacity:1; color: rgba(255,255,255,0.98); }
    .ios-switch[data-state="on"] .label .off{ opacity:0.35; }
    .ios-switch[data-state="off"] .label .off{ opacity:1; color: rgba(255,255,255,0.98); }
    .ios-switch[data-state="off"] .label .on{ opacity:0.35; }

    .track{
      position: relative;
      width: calc(var(--switch-w) - 64px);
      height: var(--switch-h);
      border-radius: 999px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.30);
      overflow:hidden;
      flex: 0 0 auto;
      box-shadow:none !important;
    }

    .thumb{
      position:absolute;
      top: var(--switch-pad);
      left: var(--switch-pad);
      width: calc(50% - (var(--switch-pad) * 2));
      height: calc(100% - (var(--switch-pad) * 2));
      border-radius: 999px;
      background: rgba(255,255,255,0.92);
      transition: transform .22s steps(12,end), background .18s steps(12,end);
      transform: translateX(0);
      box-shadow:none !important;
    }

    .ios-switch[data-state="on"] .thumb{
      transform: translateX(100%);
      background: rgba(255,46,46,0.95);
    }

    .track-btn{
      position:absolute;
      inset:0;
      background: transparent;
      border:0;
      cursor:pointer;
      padding:0;
    }

    /* readable switch on OFF */
    body.mode-off .ios-switch .label{ color: rgba(0,0,0,0.92); }
    body.mode-off .track{ background: rgba(0,0,0,0.10); border-color: rgba(0,0,0,0.42); }
    body.mode-off .thumb{ background: rgba(255,255,255,0.98); border: 1px solid rgba(0,0,0,0.35); }
    body.mode-off .ios-switch[data-state="on"] .thumb{ background: rgba(255,46,46,0.96); border-color: rgba(0,0,0,0.30); }

    /* ========= OFF SCENE (PIXEL DESKTOP + MESSENGER) ========= */
    .off-scene{
      position:fixed;
      inset:0;
      z-index:50;
      display:none;
      pointer-events:none;
      height: calc(var(--vh, 1vh) * 100);
    }
    body.mode-off .off-scene{
      display:block;
      pointer-events:auto;
    }
    body.mode-off .on-scene{
      opacity:0;
      pointer-events:none;
    }

    .pixel-desktop{
      position:absolute;
      inset:0;
      background:
        linear-gradient(0deg, rgba(0,0,0,0.06), rgba(0,0,0,0.06)),
        repeating-linear-gradient(90deg, rgba(0,0,0,0.03) 0 1px, transparent 1px 3px),
        repeating-linear-gradient(0deg, rgba(0,0,0,0.03) 0 1px, transparent 1px 3px),
        var(--off-bg);
      image-rendering: pixelated;
      filter: saturate(0.95);
    }

    .pixel-taskbar{
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      height: 44px;
      background: #e9e9e9;
      border-top: 3px solid #cfcfcf;
      box-shadow: inset 0 2px 0 rgba(255,255,255,0.6);
      display:flex;
      align-items:center;
      gap:10px;
      padding: 0 10px;
      font-family: 'Fira Code', monospace;
      font-size: 12px;
      color:#1a1a1a;
      image-rendering: pixelated;
    }
    .pixel-start{
      background:#fff;
      border:2px solid #1a1a1a;
      padding: 6px 10px;
      box-shadow: 2px 2px 0 #1a1a1a;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight:700;
    }
    .pixel-clock{
      margin-left:auto;
      background:#fff;
      border:2px solid #1a1a1a;
      padding: 6px 10px;
      box-shadow: 2px 2px 0 #1a1a1a;
    }

    .messenger-window{
      position:absolute;
      left:50%;
      top:52%;
      transform:translate(-50%,-50%);
      width: min(980px, 92vw);
      height: min(560px, 64vh);
      background:#ffffff;
      border:4px solid var(--red);
      box-shadow: 8px 8px 0 rgba(0,0,0,0.85);
      image-rendering: pixelated;
      font-family: 'Fira Code', monospace;
      color:#111;
      display:flex;
      flex-direction:column;
    }

    .messenger-titlebar{
      height:44px;
      background: #fff;
      border-bottom: 3px solid #111;
      display:flex;
      align-items:center;
      padding: 0 12px;
      gap:10px;
      font-weight:800;
      letter-spacing:0.14em;
      text-transform:uppercase;
    }
    .win-dots{ display:flex; gap:8px; margin-left:auto; }
    .dot{ width:12px; height:12px; background:#111; box-shadow: 2px 2px 0 #111; }
    .dot.red{ background: var(--red); box-shadow: 2px 2px 0 #111; }

    .messenger-body{
      flex:1;
      display:grid;
      grid-template-columns: 320px 1fr;
      min-height:0;
    }

    .sidebar{
      border-right: 3px solid #111;
      background:
        repeating-linear-gradient(0deg, rgba(0,0,0,0.04) 0 1px, transparent 1px 3px),
        #fdfdfd;
      padding: 10px;
      overflow:auto;
    }
    .tab{
      border:2px solid #111;
      box-shadow: 2px 2px 0 #111;
      padding: 8px 10px;
      margin-bottom: 10px;
      background:#fff;
      font-weight:800;
      letter-spacing:0.06em;
      cursor:pointer;
      user-select:none;
      transition: transform .14s steps(12,end);
    }
    .tab:active{ transform: translate(1px,1px); }
    .tab.active{
      border-color: var(--red);
      box-shadow: 2px 2px 0 #111, 0 0 0 2px rgba(255,46,46,0.18) inset;
    }

    .pane{
      padding: 12px;
      overflow:auto;
      background:
        repeating-linear-gradient(0deg, rgba(0,0,0,0.03) 0 1px, transparent 1px 3px),
        #ffffff;
      min-height:0;
      position:relative;
    }
    .pane-title{
      font-weight:900;
      letter-spacing:0.14em;
      text-transform:uppercase;
      font-size:12px;
      margin: 2px 0 10px;
      color:#111;
    }
    .pane-card{
      border:2px solid #111;
      box-shadow: 2px 2px 0 #111;
      background:#fff;
      padding: 12px;
      line-height:1.25;
      font-size: 12px;
    }

    .pixel-bullets{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
    }
    .pixel-bullets li{
      margin: 8px 0;
      padding-left: 14px;
      position:relative;
    }
    .pixel-bullets li::before{
      content:"■";
      position:absolute;
      left:0;
      top:0;
      color: var(--red);
    }

    .compose{
      height: 56px;
      border-top: 3px solid #111;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 0 12px;
      background:#fff;
    }
    .input{
      flex:1;
      height: 34px;
      border:2px solid #111;
      box-shadow: 2px 2px 0 #111;
      padding: 0 10px;
      display:flex;
      align-items:center;
      font-size: 12px;
      color:#777;
    }
    .send{
      width: 92px;
      height: 34px;
      border:2px solid #111;
      box-shadow: 2px 2px 0 #111;
      background: var(--red);
      color:#fff;
      font-weight:900;
      letter-spacing:0.14em;
      text-transform:uppercase;
      font-size: 12px;
    }

    /* Random pixel slogans */
    .slogan{
      position:absolute;
      font-family:'Fira Code', monospace;
      font-size: 12px;
      font-weight:900;
      letter-spacing:0.10em;
      text-transform:uppercase;
      padding: 6px 8px;
      background:#fff;
      border:2px solid #111;
      box-shadow: 2px 2px 0 #111;
      color: var(--red);
      image-rendering: pixelated;
      white-space:nowrap;
      pointer-events:none;
      opacity:0;
      transform: translateY(2px);
    }
    .slogan.on{ opacity:1; transform: translateY(0); }
    body.mode-off .slogan{ transition: opacity .20s steps(12,end), transform .20s steps(12,end); }

    /* ========= ON SCENE (TIMELINE) ========= */
    .on-scene{
      position:relative;
      inset:0;
      width:100%;
      height: calc(var(--vh, 1vh) * 100);
      z-index:60;
      transition: opacity .18s ease;
    }

    .bg-stage{
      position:fixed;
      inset:0;
      z-index:-10;
      overflow:hidden;
      background:#000;
    }
    .vid-wrap{
      position:absolute;
      inset:-12vh -12vw;
      transform:translateZ(0);
      will-change:transform,filter;
      filter: grayscale(1) contrast(1.12) brightness(.70);
    }
    .vid-wrap video{
      position:absolute;
      top:50%;
      left:50%;
      width:130vw;
      height:calc(130vw * 9 / 16);
      min-width:130vw;
      min-height:130vh;
      transform:translate(-50%,-50%);
      object-fit:cover;
      border:0;
      pointer-events:none;
    }
    .vignette{
      position:absolute;
      inset:0;
      z-index:2;
      pointer-events:none;
      background:
        radial-gradient(1100px 650px at 50% 45%,
          rgba(0,0,0,0.05),
          rgba(0,0,0,0.72) 70%,
          rgba(0,0,0,0.92));
    }

    /* keep fire glued to bottom (no floating) */
    .ascii-fire{
      position:absolute;
      left:0;
      right:0;
      bottom: env(safe-area-inset-bottom, 0px);
      width:100vw;
      z-index:4;
      pointer-events:none;
      font-family: 'Fira Code', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight:500;
      line-height:1;
      white-space:pre;
      margin:0;
      padding:0;
      color: var(--ui-accent);
      opacity:0.92;
      mix-blend-mode: screen;
      transform: translateZ(0);
      letter-spacing: 0.06em;
      font-size: clamp(10px, 1.15vw, 13px);
      text-align: left;
    }

    /* Years lifted up */
    .year-display{
      position:absolute;
      inset:0;
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:8;
      perspective:1000px;
      pointer-events:none;
      transform: translateY(calc(-1 * var(--year-lift)));
    }

    .huge-text{
      pointer-events:auto;
      cursor:pointer;
      font-family:'Anton',sans-serif;
      font-size:min(28.6vw, 286px);
      line-height:0.88;
      width:100vw;
      text-align:center;
      letter-spacing:-0.02em;
      text-transform:uppercase;
      position:absolute;
      white-space:nowrap;
      color: var(--red);
      transition: transform .8s cubic-bezier(.2,1,.3,1), opacity .65s cubic-bezier(.2,1,.3,1);
      will-change: transform, opacity;
    }
    .huge-text .ch{ display:inline-block; will-change: transform, opacity; }
    .huge-text.active .ch{ animation: chSnapIn 720ms cubic-bezier(.12,1,.22,1) both; }
    .huge-text.active .ch:nth-child(1){ animation-delay: 0ms; }
    .huge-text.active .ch:nth-child(2){ animation-delay: 40ms; }
    .huge-text.active .ch:nth-child(3){ animation-delay: 80ms; }
    .huge-text.active .ch:nth-child(4){ animation-delay: 120ms; }
    @keyframes chSnapIn{
      0%   { transform: translateY(32px) rotateX(42deg) scale(1.06); opacity:0; }
      55%  { transform: translateY(-6px) rotateX(0deg) scale(1.0); opacity:1; }
      100% { transform: translateY(0px) rotateX(0deg) scale(1.0); opacity:1; }
    }
    .huge-text.enter-right{ transform:translateX(58vw) rotateY(-18deg); opacity:0; }
    .huge-text.enter-left { transform:translateX(-58vw) rotateY(18deg); opacity:0; }
    .huge-text.active     { transform:translateX(0) rotateY(0); opacity:1; }
    .huge-text.exit-left  { transform:translateX(-58vw) rotateY(18deg); opacity:0; }
    .huge-text.exit-right { transform:translateX(58vw) rotateY(-18deg); opacity:0; }

    /* TIMELINE */
    .thread-container{
      position:absolute;
      left:0;
      bottom: calc(16vh + env(safe-area-inset-bottom, 0px));
      width:100%;
      height:34px;
      z-index:30;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 10vw;
      box-sizing:border-box;
      pointer-events:auto;
    }
    .thread-line{
      position:absolute;
      top:50%;
      left:10vw;
      right:10vw;
      height:2px;
      background: var(--ui-line);
      z-index:0;
      transform: translateY(-50%);
    }

    .milestone{
      width: var(--dot);
      height: var(--dot);
      border-radius: 999px;
      position:relative;
      z-index:1;
      display:block;
      cursor:pointer;
      pointer-events:auto;
      overflow: visible;
      background: rgba(255,255,255,0.18);
      border: 2px solid rgba(255,255,255,0.45);
      transform: translateZ(0);
      transition: transform .22s steps(12,end), background .22s steps(12,end), border-color .22s steps(12,end), box-shadow .22s steps(12,end), opacity .22s steps(12,end);
      opacity: 0.75;
    }

    .milestone:hover{
      opacity: 0.95;
      transform: scale(1.08);
    }

    /* flame replaces dot and is perfectly centered */
    .milestone .flame{
      position:absolute;
      left:50%;
      top:50%;
      width: var(--flame);
      height: var(--flame);
      transform: translate(-50%,-50%);
      display:none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.45));
      pointer-events:none;
    }

    .milestone.active{
      background: rgba(255,255,255,0.00);
      border-color: transparent;
      opacity: 1;
      transform: none;
      box-shadow: 0 0 18px rgba(255,255,255,0.55);
    }
    .milestone.active .flame{ display:block; }
    .milestone.active::after{
      content:"";
      position:absolute;
      inset:-8px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(255,255,255,0.22), rgba(255,255,255,0.00) 70%);
      pointer-events:none;
    }

    .flame .fill-accent{ fill: var(--ui-accent); }
    .flame .fill-primary{ fill: var(--ui-primary); }

    /* INFO */
    .info-wrap{
      position:absolute;
      bottom: calc(23vh + env(safe-area-inset-bottom, 0px));
      left:0;
      width:100%;
      text-align:center;
      z-index:35;
      pointer-events:none;
    }
    .info-label{
      font-size:.78rem;
      letter-spacing:4px;
      text-transform:uppercase;
      color: var(--ui-muted);
      margin-bottom:.65rem;
      text-shadow:0 0 18px rgba(0,0,0,.55);
      font-family:'Fira Code', monospace;
      font-weight:900;
    }
    .info-title{
      font-size: clamp(20px, 2.2vw, 34px);
      font-weight:300;
      color: var(--ui-primary);
      opacity:0;
      transform: translateY(16px);
      transition: opacity .45s, transform .45s;
      text-shadow:0 0 30px rgba(0,0,0,.65);
      margin: 0;
    }
    .info-title.visible{ opacity:1; transform: translateY(0); }
    .info-desc{
      margin: 10px auto 0;
      max-width: min(72ch, 86vw);
      font-size: clamp(13px, 1.1vw, 16px);
      line-height: 1.35;
      color: var(--ui-muted);
      opacity: 0;
      transform: translateY(12px);
      transition: opacity .45s, transform .45s;
      text-shadow: 0 0 24px rgba(0,0,0,0.55);
    }
    .info-desc.visible{ opacity: 1; transform: translateY(0); }

    /* clickable media slots under description */
    .phase-media{
      margin: 12px auto 0;
      width: min(980px, 92vw);
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:stretch;
      opacity:0;
      transform: translateY(10px);
      transition: opacity .45s, transform .45s;
      pointer-events:auto;
    }
    .phase-media.visible{ opacity:1; transform: translateY(0); }
    .media-slot{
      flex: 0 1 280px;
      border: 2px dashed rgba(255,255,255,0.55);
      background:
        repeating-linear-gradient(45deg, rgba(255,255,255,0.08) 0 10px, rgba(255,255,255,0.00) 10px 20px);
      border-radius: 12px;
      height: 120px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:'Fira Code', monospace;
      font-weight:900;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color: rgba(255,255,255,0.82);
      text-shadow: 0 0 18px rgba(0,0,0,0.55);
      cursor:pointer;
      user-select:none;
      overflow:hidden;
    }
    .media-slot img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      pointer-events:none;
    }
    body.invert .media-slot{
      border-color: rgba(255,46,46,0.55);
      background:
        repeating-linear-gradient(45deg, rgba(255,46,46,0.10) 0 10px, rgba(255,46,46,0.00) 10px 20px);
      color: rgba(255,46,46,0.92);
      text-shadow: none;
    }
    .media-slot.disabled{
      opacity:0.55;
      cursor:not-allowed;
    }

    /* LIGHTBOX */
    .lightbox{
      position:fixed;
      inset:0;
      z-index:1000;
      display:none;
      align-items:center;
      justify-content:center;
      padding:
        max(16px, env(safe-area-inset-top, 0px))
        max(16px, env(safe-area-inset-right, 0px))
        max(16px, env(safe-area-inset-bottom, 0px))
        max(16px, env(safe-area-inset-left, 0px));
      background: rgba(0,0,0,0.82);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .lightbox.open{ display:flex; }

    .lightbox-card{
      width: min(1100px, 94vw);
      height: min(720px, 82vh);
      border-radius: 16px;
      border: 2px solid rgba(255,255,255,0.22);
      box-shadow: 0 40px 160px rgba(0,0,0,0.65);
      background: rgba(8,8,8,0.55);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .lightbox-top{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.14);
      font-family:'Fira Code', monospace;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color: rgba(255,255,255,0.88);
      font-weight:900;
      font-size: 11px;
    }
    .lb-spacer{ margin-left:auto; }
    .lb-btn{
      height: 30px;
      padding: 0 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.24);
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.9);
      font-family:'Fira Code', monospace;
      font-weight:900;
      letter-spacing:0.12em;
      text-transform:uppercase;
      font-size: 11px;
      cursor:pointer;
    }
    .lightbox-body{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 12px;
    }
    .lightbox-body img{
      width:100%;
      height:100%;
      object-fit:contain;
      border-radius: 12px;
      background: rgba(0,0,0,0.25);
    }

    @media (max-width: 560px){
      :root{
        --switch-w: 156px;
        --switch-h: 14px;
        --dot: 16px;
        --flame: 26px;
        --year-lift: 12vh;
      }
      .topbar{ top: 12px; left: 12px; }
      .ios-switch .label{ font-size: 9px; gap:6px; }
      .messenger-body{ grid-template-columns: 1fr; }
      .sidebar{ border-right:0; border-bottom:3px solid #111; }
      .thread-container{ bottom: calc(15vh + env(safe-area-inset-bottom, 0px)); height:34px; }
      .phase-media{
        width: min(980px, 92vw);
        overflow-x:auto;
        justify-content:flex-start;
        padding: 0 6px;
        -webkit-overflow-scrolling: touch;
      }
      .media-slot{ flex: 0 0 240px; }
      .lightbox-card{ height: min(640px, 84vh); }
    }

    /* iPad/iPhone “desktop layout” mode */
    body.mobile-desktop{ -webkit-text-size-adjust:100%; }
    body.mobile-desktop .messenger-body{ grid-template-columns: 320px 1fr; }
    body.mobile-desktop .sidebar{ border-right: 3px solid #111; border-bottom:0; }
    body.mobile-desktop .pane-title{ font-size: 13px; }
    body.mobile-desktop .pane-card{ font-size: 13px; }
    body.mobile-desktop .tab{ font-size: 13px; }
  </style>
</head>

<body class="mode-on">

  <!-- SWITCH -->
  <div class="topbar">
    <div class="ios-switch" id="modeSwitch" data-state="on" aria-label="Mode switch">
      <div class="label">
        <span class="off">OFF</span>
        <span class="on">ON</span>
      </div>
      <div class="track">
        <div class="thumb"></div>
        <button class="track-btn" id="switchBtn" aria-label="Toggle"></button>
      </div>
    </div>
  </div>

  <!-- OFF SCENE -->
  <div class="off-scene" id="offScene" aria-hidden="true">
    <div class="pixel-desktop" id="pixelDesktop"></div>

    <div class="messenger-window">
      <div class="messenger-titlebar">
        PIXEL MESSENGER
        <div class="win-dots">
          <div class="dot"></div>
          <div class="dot red"></div>
          <div class="dot"></div>
        </div>
      </div>

      <div class="messenger-body">
        <div class="sidebar" id="tabs">
          <div class="tab active" data-tab="q">Исследовательские вопросы</div>
          <div class="tab" data-tab="e">Эмпирические данные</div>
          <div class="tab" data-tab="m">Метод</div>
          <div class="tab" data-tab="u">Уникальные характеристики протестных сообщений</div>
          <div class="tab" data-tab="i">Инфраструктура кибер-мобилизации</div>
          <div class="tab" data-tab="l">Лидеры "Youth Against Corruption"</div>
          <div class="tab" data-tab="h">Горизонтальные практики взаимного обучения</div>
          <div class="tab" data-tab="n">Новости: как протест увидели медиа</div>
          <div class="tab" data-tab="c">Два взгляда: нарратив и цитаты</div>
          <div class="tab" data-tab="g">Коллективная идентичность «Gen Z»</div>
          <div class="tab" data-tab="k">Ключевые находки</div>
          <div class="tab" data-tab="s">Выводы</div>
        </div>

        <div class="pane" id="pane">
          <!-- injected by JS -->
        </div>
      </div>

      <div class="compose">
        <div class="input">type a message…</div>
        <button class="send" type="button">SEND</button>
      </div>
    </div>

    <div class="pixel-taskbar">
      <div class="pixel-start">MENU</div>
      <div>PIXEL DESKTOP</div>
      <div class="pixel-clock" id="pixelClock">00:00</div>
    </div>
  </div>

  <!-- ON SCENE -->
  <div class="on-scene" id="onScene">
    <div class="bg-stage" aria-hidden="true">
      <div class="vid-wrap" id="vidWrap">
        <video id="bgVideo" autoplay muted loop playsinline preload="auto">
          <source src="BG.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="vignette"></div>
      <pre class="ascii-fire" id="asciiFire"></pre>
    </div>

    <div class="year-display" id="yearContainer"></div>

    <div class="thread-container" id="timeline">
      <div class="thread-line"></div>

      <!-- 7 milestones -->
      <div class="milestone" data-idx="0" aria-label="2018">
        <svg class="flame" viewBox="0 0 64 64" aria-hidden="true">
          <path class="fill-primary" d="M49 8l3 9 9 3-9 3-3 9-3-9-9-3 9-3 3-9z" opacity="0.95"/>
          <path class="fill-accent" d="M31.8 58c-10.7 0-19.4-8.2-19.4-18.3 0-7.2 4.1-12.6 10.4-18.6 2.8-2.7 3.6-6.2 3.8-9.1.2-2.7 0-5.2 0-5.2s8.7 6 11.3 13.6c.7 2.1 1.1 4.4 1 6.5 2.6-2 4-4.8 4-4.8s7.3 6.3 7.3 16.7C50.2 50 42 58 31.8 58z"/>
          <path class="fill-primary" d="M31.6 53.2c-6.8 0-12.3-5.2-12.3-11.6 0-4.8 2.8-8.4 6.8-12.2 2.2-2.1 3-4.7 3.2-7.2 3.1 2.8 5.4 6.9 5.4 11.2 0 1.6-.3 3.1-.9 4.5 2-1 3.4-2.6 4.3-4.4 1.8 2.5 2.7 5.3 2.7 8.1 0 6.4-5.5 11.6-12.2 11.6z" opacity="0.92"/>
        </svg>
      </div>

      <div class="milestone" data-idx="1" aria-label="2019">
        <svg class="flame" viewBox="0 0 64 64" aria-hidden="true">
          <path class="fill-primary" d="M49 8l3 9 9 3-9 3-3 9-3-9-9-3 9-3 3-9z" opacity="0.95"/>
          <path class="fill-accent" d="M31.8 58c-10.7 0-19.4-8.2-19.4-18.3 0-7.2 4.1-12.6 10.4-18.6 2.8-2.7 3.6-6.2 3.8-9.1.2-2.7 0-5.2 0-5.2s8.7 6 11.3 13.6c.7 2.1 1.1 4.4 1 6.5 2.6-2 4-4.8 4-4.8s7.3 6.3 7.3 16.7C50.2 50 42 58 31.8 58z"/>
          <path class="fill-primary" d="M31.6 53.2c-6.8 0-12.3-5.2-12.3-11.6 0-4.8 2.8-8.4 6.8-12.2 2.2-2.1 3-4.7 3.2-7.2 3.1 2.8 5.4 6.9 5.4 11.2 0 1.6-.3 3.1-.9 4.5 2-1 3.4-2.6 4.3-4.4 1.8 2.5 2.7 5.3 2.7 8.1 0 6.4-5.5 11.6-12.2 11.6z" opacity="0.92"/>
        </svg>
      </div>

      <div class="milestone" data-idx="2" aria-label="2020">
        <svg class="flame" viewBox="0 0 64 64" aria-hidden="true">
          <path class="fill-primary" d="M49 8l3 9 9 3-9 3-3 9-3-9-9-3 9-3 3-9z" opacity="0.95"/>
          <path class="fill-accent" d="M31.8 58c-10.7 0-19.4-8.2-19.4-18.3 0-7.2 4.1-12.6 10.4-18.6 2.8-2.7 3.6-6.2 3.8-9.1.2-2.7 0-5.2 0-5.2s8.7 6 11.3 13.6c.7 2.1 1.1 4.4 1 6.5 2.6-2 4-4.8 4-4.8s7.3 6.3 7.3 16.7C50.2 50 42 58 31.8 58z"/>
          <path class="fill-primary" d="M31.6 53.2c-6.8 0-12.3-5.2-12.3-11.6 0-4.8 2.8-8.4 6.8-12.2 2.2-2.1 3-4.7 3.2-7.2 3.1 2.8 5.4 6.9 5.4 11.2 0 1.6-.3 3.1-.9 4.5 2-1 3.4-2.6 4.3-4.4 1.8 2.5 2.7 5.3 2.7 8.1 0 6.4-5.5 11.6-12.2 11.6z" opacity="0.92"/>
        </svg>
      </div>

      <div class="milestone" data-idx="3" aria-label="2021">
        <svg class="flame" viewBox="0 0 64 64" aria-hidden="true">
          <path class="fill-primary" d="M49 8l3 9 9 3-9 3-3 9-3-9-9-3 9-3 3-9z" opacity="0.95"/>
          <path class="fill-accent" d="M31.8 58c-10.7 0-19.4-8.2-19.4-18.3 0-7.2 4.1-12.6 10.4-18.6 2.8-2.7 3.6-6.2 3.8-9.1.2-2.7 0-5.2 0-5.2s8.7 6 11.3 13.6c.7 2.1 1.1 4.4 1 6.5 2.6-2 4-4.8 4-4.8s7.3 6.3 7.3 16.7C50.2 50 42 58 31.8 58z"/>
          <path class="fill-primary" d="M31.6 53.2c-6.8 0-12.3-5.2-12.3-11.6 0-4.8 2.8-8.4 6.8-12.2 2.2-2.1 3-4.7 3.2-7.2 3.1 2.8 5.4 6.9 5.4 11.2 0 1.6-.3 3.1-.9 4.5 2-1 3.4-2.6 4.3-4.4 1.8 2.5 2.7 5.3 2.7 8.1 0 6.4-5.5 11.6-12.2 11.6z" opacity="0.92"/>
        </svg>
      </div>

      <div class="milestone" data-idx="4" aria-label="2022">
        <svg class="flame" viewBox="0 0 64 64" aria-hidden="true">
          <path class="fill-primary" d="M49 8l3 9 9 3-9 3-3 9-3-9-9-3 9-3 3-9z" opacity="0.95"/>
          <path class="fill-accent" d="M31.8 58c-10.7 0-19.4-8.2-19.4-18.3 0-7.2 4.1-12.6 10.4-18.6 2.8-2.7 3.6-6.2 3.8-9.1.2-2.7 0-5.2 0-5.2s8.7 6 11.3 13.6c.7 2.1 1.1 4.4 1 6.5 2.6-2 4-4.8 4-4.8s7.3 6.3 7.3 16.7C50.2 50 42 58 31.8 58z"/>
          <path class="fill-primary" d="M31.6 53.2c-6.8 0-12.3-5.2-12.3-11.6 0-4.8 2.8-8.4 6.8-12.2 2.2-2.1 3-4.7 3.2-7.2 3.1 2.8 5.4 6.9 5.4 11.2 0 1.6-.3 3.1-.9 4.5 2-1 3.4-2.6 4.3-4.4 1.8 2.5 2.7 5.3 2.7 8.1 0 6.4-5.5 11.6-12.2 11.6z" opacity="0.92"/>
        </svg>
      </div>

      <div class="milestone" data-idx="5" aria-label="2023">
        <svg class="flame" viewBox="0 0 64 64" aria-hidden="true">
          <path class="fill-primary" d="M49 8l3 9 9 3-9 3-3 9-3-9-9-3 9-3 3-9z" opacity="0.95"/>
          <path class="fill-accent" d="M31.8 58c-10.7 0-19.4-8.2-19.4-18.3 0-7.2 4.1-12.6 10.4-18.6 2.8-2.7 3.6-6.2 3.8-9.1.2-2.7 0-5.2 0-5.2s8.7 6 11.3 13.6c.7 2.1 1.1 4.4 1 6.5 2.6-2 4-4.8 4-4.8s7.3 6.3 7.3 16.7C50.2 50 42 58 31.8 58z"/>
          <path class="fill-primary" d="M31.6 53.2c-6.8 0-12.3-5.2-12.3-11.6 0-4.8 2.8-8.4 6.8-12.2 2.2-2.1 3-4.7 3.2-7.2 3.1 2.8 5.4 6.9 5.4 11.2 0 1.6-.3 3.1-.9 4.5 2-1 3.4-2.6 4.3-4.4 1.8 2.5 2.7 5.3 2.7 8.1 0 6.4-5.5 11.6-12.2 11.6z" opacity="0.92"/>
        </svg>
      </div>

      <div class="milestone" data-idx="6" aria-label="2024">
        <svg class="flame" viewBox="0 0 64 64" aria-hidden="true">
          <path class="fill-primary" d="M49 8l3 9 9 3-9 3-3 9-3-9-9-3 9-3 3-9z" opacity="0.95"/>
          <path class="fill-accent" d="M31.8 58c-10.7 0-19.4-8.2-19.4-18.3 0-7.2 4.1-12.6 10.4-18.6 2.8-2.7 3.6-6.2 3.8-9.1.2-2.7 0-5.2 0-5.2s8.7 6 11.3 13.6c.7 2.1 1.1 4.4 1 6.5 2.6-2 4-4.8 4-4.8s7.3 6.3 7.3 16.7C50.2 50 42 58 31.8 58z"/>
          <path class="fill-primary" d="M31.6 53.2c-6.8 0-12.3-5.2-12.3-11.6 0-4.8 2.8-8.4 6.8-12.2 2.2-2.1 3-4.7 3.2-7.2 3.1 2.8 5.4 6.9 5.4 11.2 0 1.6-.3 3.1-.9 4.5 2-1 3.4-2.6 4.3-4.4 1.8 2.5 2.7 5.3 2.7 8.1 0 6.4-5.5 11.6-12.2 11.6z" opacity="0.92"/>
        </svg>
      </div>
    </div>

    <div class="info-wrap">
      <div class="info-label" id="label">TIMELINE</div>
      <h1 class="info-title" id="infoTitle"></h1>
      <p class="info-desc" id="infoDesc"></p>
      <div class="phase-media" id="phaseMedia"></div>
    </div>
  </div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div class="lightbox-card" role="dialog" aria-modal="true" aria-label="Image preview">
      <div class="lightbox-top">
        <div id="lbTitle">SCREEN</div>
        <div class="lb-spacer"></div>
        <button class="lb-btn" id="lbClose" type="button">CLOSE</button>
      </div>
      <div class="lightbox-body">
        <img id="lbImg" alt="">
      </div>
    </div>
  </div>

  <script>
    // ===== iOS/iPad: stable viewport height =====
    (function(){
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
        (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      if (isIOS) document.body.classList.add('mobile-desktop');

      function setVhVar(){
        const h = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight;
        document.documentElement.style.setProperty('--vh', (h * 0.01) + 'px');
      }
      setVhVar();
      window.addEventListener('resize', setVhVar);
      if (window.visualViewport) window.visualViewport.addEventListener('resize', setVhVar);
    })();

    function viewportSize(){
      const vv = window.visualViewport;
      return {
        w: (vv && vv.width) ? vv.width : window.innerWidth,
        h: (vv && vv.height) ? vv.height : window.innerHeight
      };
    }

    // ========= FPS CONTROL (old OS vibe) =========
    const OFF_FPS = 12;
    const OFF_TICK_MS = Math.round(1000 / OFF_FPS);

    // ========= SWITCH / MODES =========
    const modeSwitch = document.getElementById('modeSwitch');
    const switchBtn = document.getElementById('switchBtn');

    function setMode(on) {
      const state = on ? "on" : "off";
      modeSwitch.setAttribute("data-state", state);
      document.body.classList.toggle("mode-on", on);
      document.body.classList.toggle("mode-off", !on);

      if (bgVideo) {
        if (on) { forcePlay(); }
        else { try { bgVideo.pause(); } catch(e){} }
      }

      if (!on) startOffLoops();
      else stopOffLoops();
    }

    switchBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const isOn = modeSwitch.getAttribute("data-state") === "on";
      setMode(!isOn);
    });

    // Pixel clock
    const pixelClock = document.getElementById('pixelClock');
    function pad2(n){ return String(n).padStart(2,'0'); }
    function tickClock(){
      const d = new Date();
      pixelClock.textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }
    tickClock();
    setInterval(tickClock, 1000);

    // ========= OFF TABS CONTENT =========
    const pane = document.getElementById('pane');
    const tabsWrap = document.getElementById('tabs');

    const tabContent = {
      q: `
        <div class="pane-title">Исследовательские вопросы</div>
        <div class="pane-card">
          1) Как устроена циркуляция протестных сообщений между платформами?<br><br>
          2) Какие признаки позволяют отличить “органический” рост от управляемой мобилизации?<br><br>
          3) Как меняется язык призывов при переходе от локальной повестки к общему движению?
        </div>
      `,
      e: `
        <div class="pane-title">Эмпирические данные</div>
        <div class="pane-card">
          Корпус сообщений и постов; временные ряды активности; сетевые графы взаимодействия;
          выборки по ключевым тегам и узлам распространения; медиавложения и метаданные публикаций.
        </div>
      `,
      m: `
        <div class="pane-title">Метод</div>
        <div class="pane-card">
          Сбор → очистка → разметка → анализ.
          <ul class="pixel-bullets">
            <li>Контент-анализ (мотивы, риторика, фреймы)</li>
            <li>Сетевой анализ (узлы, мосты, кластеры)</li>
            <li>Темпоральный анализ (волны, триггеры, отклики)</li>
            <li>Качественная проверка кейсами (ручные срезы)</li>
          </ul>
        </div>
      `,
      u: `
        <div class="pane-title">Уникальные характеристики протестных сообщений</div>
        <div class="pane-card">
          Короткие формулы → меметичность → “инструкции” → микро-ритуалы → переводы между платформами.
        </div>
      `,
      i: `
        <div class="pane-title">Инфраструктура кибер-мобилизации</div>
        <div class="pane-card">
          Контуры ретрансляции, “переводчики” повестки, узлы дублирования, расписания публикаций,
          точки синхронизации и периоды усиления.
        </div>
      `,
      l: `
        <div class="pane-title">Лидеры "Youth Against Corruption"</div>
        <div class="pane-card">
          Стабильные хабы распространения и организаторы “мостов” между кластерами.
          Дополнительно: роли “курьеров” и “сборщиков”.
        </div>
      `,
      h: `
        <div class="pane-title">Горизонтальные практики взаимного обучения</div>
        <div class="pane-card">
          Взаимное обучение как набор простых модулей (шаблоны, навигация, координация, поддержка).
        </div>
      `,
      n: `
        <div class="pane-title">Новости: как протест увидели медиа</div>
        <div class="pane-card">
          Медиа-оптика часто сводит сложный протест к простым “кадрам”. Разные редакции выбирают разные рамки.
        </div>
      `,
      c: `
        <div class="pane-title">Два взгляда: нарратив и цитаты</div>
        <div class="pane-card">
          Сопоставление объясняющей рамки и “голоса изнутри”.
        </div>
      `,
      g: `
        <div class="pane-title">Коллективная идентичность «Gen Z»</div>
        <div class="pane-card">
          Идентичность как инструмент координации: общий язык, этический код, опыт и тактики.
        </div>
      `,
      k: `
        <div class="pane-title">Ключевые находки</div>
        <div class="pane-card">
          Сигналы, маршруты, роли, динамика — как блоки “панели управления”.
        </div>
      `,
      s: `
        <div class="pane-title">Выводы</div>
        <div class="pane-card">
          Сообщения работают как интерфейс коллективного действия: объясняют, координируют, создают принадлежность.
        </div>
      `
    };

    function renderTab(key){
      pane.innerHTML = tabContent[key] || `<div class="pane-title">…</div><div class="pane-card">Нет данных.</div>`;
      pane.scrollTop = 0;
    }

    tabsWrap.addEventListener('click', (e) => {
      const t = e.target.closest('.tab');
      if(!t) return;
      const key = t.getAttribute('data-tab');
      Array.from(tabsWrap.querySelectorAll('.tab')).forEach(el => el.classList.toggle('active', el === t));
      renderTab(key);
    });

    renderTab('q');

    // ========= OFF RANDOM SLOGANS (12fps-ish) =========
    const pixelDesktop = document.getElementById('pixelDesktop');

    const slogans = [
      "NO CAP","BASED","TOUCH GRASS","WE MOVE","СТОЙКОСТЬ",
      "СВОБОДА ДЛЯ ВСЕХ","ПРАВА НЕ ТИШИНА","ГОЛОС ИМЕЕТ ЗНАЧЕНИЕ",
      "НЕ НОРМА • НЕ ОК","WE SEE YOU","SAY IT LOUD","KEEP SIGNAL","ДЕРЖИ СИГНАЛ"
    ];

    let offSloganTimer = null;

    function quantizedTimeout(fn, ms){
      const steps = Math.max(1, Math.round(ms / OFF_TICK_MS));
      return setTimeout(fn, steps * OFF_TICK_MS);
    }

    function spawnSlogan(){
      if (!document.body.classList.contains('mode-off')) return;

      const el = document.createElement('div');
      el.className = 'slogan';
      el.textContent = slogans[(Math.random() * slogans.length) | 0];

      const pad = 18;
      const vp = viewportSize();
      const w = vp.w;
      const h = vp.h;

      const maxX = Math.max(pad, w - pad - 220);
      const maxY = Math.max(pad, h - pad - 120);

      const x = Math.floor(pad + Math.random() * (maxX - pad));
      const y = Math.floor(pad + Math.random() * (maxY - pad));

      el.style.left = x + "px";
      el.style.top  = y + "px";

      pixelDesktop.appendChild(el);

      quantizedTimeout(() => el.classList.add('on'), OFF_TICK_MS);
      quantizedTimeout(() => el.classList.remove('on'), 1800 + Math.random()*900);
      quantizedTimeout(() => { if(el.parentNode) el.remove(); }, 2400 + Math.random()*900);
    }

    function startOffLoops(){
      if (offSloganTimer) return;
      offSloganTimer = setInterval(() => {
        if (Math.random() < 0.62) spawnSlogan();
      }, 900);
    }

    function stopOffLoops(){
      if (offSloganTimer){ clearInterval(offSloganTimer); offSloganTimer = null; }
    }

    // ========= ON DATA + MEDIA (click-to-open for EVERY year) =========
    const data = [
      { year: "2018", title: "SEED / ЗАРОЖДЕНИЕ", desc: "Первые искры: разрозненные группы, локальные поводы, поиск языка и символов.", media: [
        { label: "2018 SCREEN #1", src: "" },
        { label: "2018 SCREEN #2", src: "" }
      ]},
      { year: "2019", title: "IGNITION / ИМПУЛЬС", desc: "Ускорение: общие точки сборки, повторяемые сценарии, резонансные триггеры.", media: [
        { label: "2019 SCREEN #1", src: "" },
        { label: "2019 SCREEN #2", src: "image7.png" }
      ]},
      { year: "2020", title: "SHIFT / ПОВОРОТ", desc: "Смена режима: новые каналы, новые риски, новая скорость распространения сигналов.", media: [
        { label: "2020 SCREEN #1", src: "" },
        { label: "2020 SCREEN #2", src: "" }
      ]},
      { year: "2021", title: "GENESIS / ИСТОКИ", desc: "Сборка структуры: роли, протоколы, инфраструктура выживания и устойчивости.", media: [
        { label: "2021 SCREEN #1", src: "2021_1.jpg" },
        { label: "2021 SCREEN #2", src: "2021_2.jpg" }
      ]},
      { year: "2022", title: "EXPANSION / РОСТ", desc: "Расширение: география, аудитория, сложность коалиций, уровень наблюдения.", media: [
        { label: "2022 SCREEN #1", src: "" },
        { label: "2022 SCREEN #2", src: "" }
      ]},
      { year: "2023", title: "SYNERGY / СИНТЕЗ", desc: "Синтез: коалиции, совместные действия, общая грамматика визуала и поведения.", media: [
        { label: "2023 SCREEN #1", src: "" },
        { label: "2023 SCREEN #2", src: "" }
      ]},
      { year: "2024", title: "FUTURE / ЗАВТРА", desc: "Будущее: сценарии эскалации/затухания. Выбор между вспышкой и долгим тлением.", media: [
        { label: "2024 SCREEN #1", src: "" },
        { label: "2024 SCREEN #2", src: "" }
      ]}
    ];

    let currentIndex = 0;
    let isAnimating = false;

    const yearContainer = document.getElementById('yearContainer');
    const infoTitle = document.getElementById('infoTitle');
    const infoDesc  = document.getElementById('infoDesc');
    const phaseMedia = document.getElementById('phaseMedia');

    function splitChars(text) {
      return Array.from(text).map(ch => `<span class="ch">${ch}</span>`).join('');
    }

    function renderYear(index, stateClass) {
      const old = yearContainer.querySelector('.huge-text.active');
      if (old) {
        if (stateClass === 'enter-right') old.className = 'huge-text active exit-left';
        else if (stateClass === 'enter-left') old.className = 'huge-text active exit-right';
        else old.remove();
        setTimeout(() => { if (old && old.parentNode) old.remove(); }, 800);
      }

      const el = document.createElement('div');
      el.className = `huge-text ${stateClass}`;
      el.innerHTML = splitChars(data[index].year);

      yearContainer.appendChild(el);

      requestAnimationFrame(() => {
        el.classList.remove(stateClass);
        el.classList.add('active');
      });
    }

    function renderPhaseMedia(index){
      const items = (data[index] && data[index].media) ? data[index].media : [];
      phaseMedia.innerHTML = items.map((it, i) => {
        const src = (it.src || "").trim();
        const label = (it.label || "IMAGE PLACEHOLDER");
        const safeLabel = label.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
        const safeSrc = src.replace(/"/g,"&quot;");

        if (src){
          return `
            <div class="media-slot" data-year="${data[index].year}" data-idx="${i}" data-src="${safeSrc}" data-label="${safeLabel}" title="Open">
              <img src="${safeSrc}" alt="">
            </div>`;
        }
        return `
          <div class="media-slot disabled" data-year="${data[index].year}" data-idx="${i}" data-src="" data-label="${safeLabel}" title="No image yet">
            ${safeLabel}
          </div>`;
      }).join("");

      phaseMedia.classList.add('visible');
    }

    function updateInfo(index){
      infoTitle.classList.remove('visible');
      infoDesc.classList.remove('visible');
      phaseMedia.classList.remove('visible');

      setTimeout(() => {
        infoTitle.textContent = data[index].title || "";
        infoDesc.textContent = data[index].desc || "";
        infoTitle.classList.add('visible');
        infoDesc.classList.add('visible');
        renderPhaseMedia(index);
      }, 240);
    }

    const timeline = document.getElementById('timeline');
    const milestones = Array.from(timeline.querySelectorAll('.milestone'));

    function updateMilestones(idx) {
      milestones.forEach((m, i) => m.classList.toggle('active', i === idx));
    }

    function goToIndex(targetIndex) {
      if (isAnimating) return;
      if (document.body.classList.contains('mode-off')) return;

      targetIndex = Math.max(0, Math.min(data.length - 1, targetIndex));
      if (targetIndex === currentIndex) return;

      isAnimating = true;

      const direction = targetIndex > currentIndex ? 1 : -1;
      const animationClass = direction > 0 ? 'enter-right' : 'enter-left';

      renderYear(targetIndex, animationClass);
      updateMilestones(targetIndex);
      updateInfo(targetIndex);

      currentIndex = targetIndex;
      setFireTargetByIndex(currentIndex);

      setTimeout(() => { isAnimating = false; }, 800);
    }

    milestones.forEach((m, idx) => {
      const handler = (e) => { e.stopPropagation(); goToIndex(idx); };
      m.addEventListener('click', handler, { passive:true });
      m.addEventListener('touchend', handler, { passive:true });
      m.addEventListener('pointerdown', (e)=>e.stopPropagation(), { passive:true });
    });

    // ===== Lightbox: open by clicking any year’s media slot (if src present) =====
    const lightbox = document.getElementById('lightbox');
    const lbImg = document.getElementById('lbImg');
    const lbTitle = document.getElementById('lbTitle');
    const lbClose = document.getElementById('lbClose');

    function openLightbox(src, title){
      if (!src) return;
      lbImg.src = src;
      lbTitle.textContent = title || "SCREEN";
      lightbox.classList.add('open');
      lightbox.setAttribute('aria-hidden','false');
    }
    function closeLightbox(){
      lightbox.classList.remove('open');
      lightbox.setAttribute('aria-hidden','true');
      lbImg.src = "";
    }

    lbClose.addEventListener('click', (e)=>{ e.preventDefault(); closeLightbox(); });
    lightbox.addEventListener('click', (e)=>{ if (e.target === lightbox) closeLightbox(); });
    window.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape' && lightbox.classList.contains('open')) closeLightbox();
    });

    phaseMedia.addEventListener('click', (e)=>{
      const slot = e.target.closest('.media-slot');
      if (!slot || slot.classList.contains('disabled')) return;
      const src = (slot.getAttribute('data-src') || "").trim();
      if (!src) return;
      const year = slot.getAttribute('data-year') || "";
      const label = slot.getAttribute('data-label') || "SCREEN";
      openLightbox(src, `${year} / ${label}`);
    });

    // ===== Ensure local video plays =====
    const bgVideo = document.getElementById('bgVideo');
    function forcePlay() {
      if (!bgVideo) return;
      bgVideo.muted = true;
      const p = bgVideo.play();
      if (p && typeof p.catch === "function") p.catch(()=>{});
    }
    forcePlay();
    setTimeout(forcePlay, 250);
    setTimeout(forcePlay, 900);
    window.addEventListener('pointerdown', forcePlay, { once:true });
    window.addEventListener('touchstart', forcePlay, { once:true, passive:true });

    // =========================
    // ASCII FIRE
    // =========================
    const FIRE_WIDTH_MULT = 1.55;
    const FIRE_MAX_COLS = 360;

    const asciiFireEl = document.getElementById('asciiFire');

    let fireCols = 0;
    let fireRowsBase = 0;
    let fireRows = 0;
    let fireTargetRows = 0;
    let fireField = null;

    const ramp = [" ", " ", ".", ":", "-", "=", "+", "*", "#", "@"];

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    function fireResize(forceReinit=false) {
      const vp = viewportSize();
      const approxCharW = 9;
      const cols = clamp(
        Math.floor((vp.w / approxCharW) * FIRE_WIDTH_MULT),
        140,
        FIRE_MAX_COLS
      );

      const approxLineH = 12;
      const basePx = vp.h * 0.05;
      const baseRows = clamp(Math.floor(basePx / approxLineH), 6, 22);

      fireCols = cols;
      fireRowsBase = baseRows;
      fireTargetRows = computeTargetRows(currentIndex);

      if (forceReinit || !fireField) {
        fireRows = fireTargetRows;
        initFireField(Math.round(fireRows), fireCols);
      }
    }

    function computeTargetRows(idx) {
      const r = fireRowsBase * (1 + idx);
      return clamp(r, fireRowsBase, fireRowsBase * data.length);
    }

    function setFireTargetByIndex(idx){
      fireTargetRows = computeTargetRows(idx);
    }

    function initFireField(rows, cols){
      fireField = new Uint16Array(rows * cols);
      const maxI = ramp.length - 1;
      const base = (rows-1) * cols;
      for (let x=0; x<cols; x++){
        fireField[base + x] = (Math.random() < 0.22) ? (maxI - 2) : maxI;
      }
    }

    function ensureFireSize() {
      const desiredRows = Math.max(1, Math.round(fireRows));
      const currentRows = fireField ? Math.floor(fireField.length / fireCols) : 0;
      if (!fireField || desiredRows !== currentRows) initFireField(desiredRows, fireCols);
    }

    function fireStep() {
      if (!fireField) return;
      const rows = Math.floor(fireField.length / fireCols);
      const cols = fireCols;
      const maxI = ramp.length - 1;

      const base = (rows-1) * cols;
      const gapChance = 0.24 + (currentIndex * 0.02);
      for (let x=0; x<cols; x++){
        if (Math.random() < gapChance) fireField[base + x] = maxI - 3;
        else fireField[base + x] = maxI;
      }

      const decayMax = currentIndex <= 1 ? 3 : 2;
      for (let y=0; y<rows-1; y++){
        for (let x=0; x<cols; x++){
          const src = (y+1)*cols + x;
          const heat = fireField[src];

          const decay = (Math.random() * (decayMax + 1)) | 0;
          const drift = ((Math.random() * 3) | 0) - 1;
          const nx = clamp(x + drift, 0, cols-1);
          const dst = y*cols + nx;

          const out = heat > decay ? (heat - decay) : 0;
          fireField[dst] = out;
        }
      }
    }

    function fireRender() {
      if (!fireField) return;
      const rows = Math.floor(fireField.length / fireCols);
      const cols = fireCols;

      const readabilityBias = currentIndex === 0 ? 2 : (currentIndex === 1 ? 1 : 0);

      let out = "";
      for (let y=0; y<rows; y++){
        const rowOff = y*cols;
        for (let x=0; x<cols; x++){
          let v = fireField[rowOff + x];
          v = clamp(v - readabilityBias, 0, ramp.length - 1);
          out += ramp[v] || " ";
        }
        if (y !== rows-1) out += "\n";
      }
      asciiFireEl.textContent = out;
    }

    function fireTick() {
      if (document.body.classList.contains('mode-on')) {
        fireRows += (fireTargetRows - fireRows) * 0.12;
        if (Math.abs(fireTargetRows - fireRows) < 0.35) fireRows = fireTargetRows;

        ensureFireSize();
        fireStep();
        fireRender();
      }
      requestAnimationFrame(fireTick);
    }

    // init
    function init() {
      renderYear(0, 'enter-right');
      requestAnimationFrame(() => {
        const el = yearContainer.querySelector('.huge-text');
        if (el && !el.classList.contains('active')) el.classList.add('active');
      });

      updateMilestones(0);
      updateInfo(0);

      fireResize(true);
      setFireTargetByIndex(0);
      fireTick();

      setMode(true);
    }

    init();

    window.addEventListener('resize', () => fireResize(true));
    if (window.visualViewport) window.visualViewport.addEventListener('resize', () => fireResize(true));
  </script>
</body>
</html>
